<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–î–Ω–µ–≤–Ω–∏–∫</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <style>
    body {
      background-color: #1f2937;
      color: #f3f4f6;
    }
    .modal { 
      opacity: 0; transform: scale(0.97); 
      transition: opacity 0.25s ease, transform 0.25s ease; 
    }
    .modal.show { opacity: 1; transform: scale(1); }
    .online-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
    .online { background-color: #10B981; }
    .offline { background-color: #EF4444; }
    .syncing { background-color: #F59E0B; }
    
    /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
    .notification {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 24px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .notification.show {
      opacity: 1;
    }
    .notification.success {
      background-color: #10B981;
    }
    .notification.error {
      background-color: #EF4444;
    }

    /* –°—Ç–∏–ª—å –¥–ª—è –ø–æ–ª—è –ø–∞—Ä–æ–ª—è */
    #adminPassword {
      color: black;
      background-color: white;
    }

    .subject-row {
      cursor: pointer;
      transition: background-color 0.2s;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .subject-row:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .subject-row:last-child {
      border-bottom: none;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */
    .image-upload {
      border: 2px dashed #ccc;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.3s;
    }

    .image-upload:hover {
      border-color: #3b82f6;
    }

    .image-upload.dragover {
      border-color: #3b82f6;
      background-color: #f0f9ff;
    }

    .uploaded-image {
      max-width: 100%;
      max-height: 200px;
      margin-top: 10px;
      border-radius: 4px;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Å—ã–ª–æ–∫ –≤ –∫–æ–Ω—Ç–µ–Ω—Ç–µ */
    .content-link {
      color: #3b82f6;
      text-decoration: underline;
    }

    .content-link:hover {
      color: #2563eb;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –∫–æ–Ω—Ç–µ–Ω—Ç–µ */
    .content-image {
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
      margin: 10px 0;
      display: block;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —á–∞—Ç–∞ */
    .chat-container {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .message-container {
      display: flex;
      align-items: flex-end;
      gap: 6px;
      max-width: 100%;
    }
    .message-container.own {
      flex-direction: row-reverse;
    }
    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      flex-shrink: 0;
      object-fit: cover;
    }
    .message-bubble {
      max-width: 70%;
      padding: 8px 12px;
      border-radius: 18px;
      position: relative;
      font-size: 14px;
      line-height: 1.4;
    }
    .message-bubble.other {
      background: #374151;
      border-bottom-left-radius: 4px;
    }
    .message-bubble.own {
      background: #3b82f6;
      border-bottom-right-radius: 4px;
    }
    .message-bubble.other::after {
      content: '';
      position: absolute;
      left: -6px;
      bottom: 0;
      width: 0;
      height: 0;
      border: 6px solid transparent;
      border-right-color: #374151;
      border-left: 0;
    }
    .message-bubble.own::after {
      content: '';
      position: absolute;
      right: -6px;
      bottom: 0;
      width: 0;
      height: 0;
      border: 6px solid transparent;
      border-left-color: #3b82f6;
      border-right: 0;
    }
    .message-sender {
      font-weight: 600;
      font-size: 12px;
      margin-bottom: 2px;
      color: #9ca3af;
    }
    .message-time {
      font-size: 11px;
      color: #6b7280;
      text-align: right;
      margin-top: 2px;
    }
    .chat-sticker {
      max-width: 120px;
      max-height: 120px;
      border-radius: 8px;
    }
    
    /* –°—Ç–∏–∫–µ—Ä—ã */
    .sticker-picker {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-top: 10px;
      padding: 10px;
      border-radius: 8px;
      background-color: #374151;
      max-height: 200px;
      overflow-y: auto;
    }
    .sticker-item {
      cursor: pointer;
      padding: 5px;
      border-radius: 8px;
      transition: background-color 0.2s;
    }
    .sticker-item:hover {
      background-color: #4b5563;
    }
    .sticker-img {
      width: 100%;
      height: auto;
      border-radius: 5px;
    }

    /* –°–µ—Ç–∫–∞ –¥–Ω–µ–π */
    .day-grid {
      background-color: #374151;
      color: white;
      border-radius: 16px;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .day-header {
      display: flex;
      border-bottom: 1px solid #4b5563;
    }
    .day-title {
      font-weight: bold;
      font-size: 18px;
      padding: 12px;
      flex: 1;
    }
    .day-homework {
      display: flex;
      align-items: center;
      border-left: 1px solid #4b5563;
      padding: 0 12px;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∞–∫–∫–∞—É–Ω—Ç–∞ */
    .auth-tabs {
      display: flex;
      border-bottom: 1px solid #4b5563;
      margin-bottom: 20px;
    }
    .auth-tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .auth-tab.active {
      background-color: #3b82f6;
      color: white;
    }
    .auth-form {
      display: none;
    }
    .auth-form.active {
      display: block;
    }
    .profile-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      margin: 0 auto 20px;
      position: relative;
      cursor: pointer;
    }
    .avatar-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 5px;
      text-align: center;
      opacity: 0;
      transition: opacity 0.3s;
      border-radius: 0 0 50% 50%;
    }
    .profile-avatar:hover .avatar-overlay {
      opacity: 1;
    }
    .nickname-edit {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    .captcha-code {
      font-family: monospace;
      font-size: 24px;
      letter-spacing: 8px;
      background: linear-gradient(45deg, #3b82f6, #8b5cf6);
      padding: 10px 20px;
      border-radius: 8px;
      margin: 10px 0;
      user-select: none;
    }
  </style>
</head>
<body class="min-h-screen p-6">

  <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
  <div id="notification" class="notification hidden"></div>

  <!-- –®–∞–ø–∫–∞ -->
  <div class="flex justify-center items-center mb-4 relative">
    <h1 class="text-2xl font-bold">üìö –î–Ω–µ–≤–Ω–∏–∫ üìö</h1>
    <div id="onlineStatus" class="absolute left-4 top-0 text-sm flex items-center">
      <span class="online-dot online"></span>
      <span>–æ–Ω–ª–∞–π–Ω</span>
    </div>
    <div id="syncStatus" class="absolute right-4 top-0 text-sm text-gray-400">
      –ó–∞–≥—Ä—É–∑–∫–∞...
    </div>
  </div>

  <!-- –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å -->
  <div class="absolute top-14 left-4 flex flex-col items-start z-40">
    <button onclick="toggleAdminLogin()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">–ê–¥–º–∏–Ω</button>
    <div id="adminLogin" class="mt-2 space-x-2 flex justify-center items-center hidden bg-gray-700 p-3 rounded shadow-lg">
      <input id="adminPassword" type="password" placeholder="–ü–∞—Ä–æ–ª—å" class="border p-2 rounded w-32">
      <button onclick="loginAdmin()" class="px-3 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition-colors">–í–æ–π—Ç–∏</button>
    </div>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤) -->
  <div id="syncButtonContainer" class="absolute top-14 left-24 flex flex-col items-start z-40 hidden">
    <button onclick="forceSync()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition-colors">
      üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å
    </button>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞ -->
  <div class="fixed bottom-4 left-4">
    <button onclick="openAccountModal()" class="w-14 h-14 bg-gray-600 rounded-full shadow-lg flex items-center justify-center hover:bg-gray-500 transition-colors">
      <img src="account.png" alt="–ê–∫–∫–∞—É–Ω—Ç" class="w-8 h-8">
    </button>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∞ —á–∞—Ç–∞ -->
  <div class="fixed bottom-4 right-4">
    <button id="chatButton" onclick="toggleChat()" class="w-14 h-14 bg-blue-500 text-white rounded-full shadow-lg flex items-center justify-center hover:bg-blue-600 transition-colors">
      üí¨
    </button>
  </div>

  <!-- Changelog —Å—Å—ã–ª–∫–∞ -->
  <div class="fixed top-2 right-4 text-gray-400 text-sm text-right">
    <a href="#" onclick="openChangelog()" class="text-blue-400 hover:text-blue-300 underline">Changelog</a>
  </div>

  <!-- –°–µ—Ç–∫–∞ –¥–Ω–µ–π -->
  <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mt-20">
    <!-- –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ -->
    <div class="day-grid">
      <div class="day-header">
        <h2 class="day-title text-red-400">–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</h2>
        <div class="day-homework"><span>–î–ó</span></div>
      </div>
      <div class="flex-1" id="mon"></div>
    </div>
    
    <!-- –í—Ç–æ—Ä–Ω–∏–∫ -->
    <div class="day-grid">
      <div class="day-header">
        <h2 class="day-title text-blue-400">–í—Ç–æ—Ä–Ω–∏–∫</h2>
        <div class="day-homework"><span>–î–ó</span></div>
      </div>
      <div class="flex-1" id="tue"></div>
    </div>
    
    <!-- –°—Ä–µ–¥–∞ -->
    <div class="day-grid">
      <div class="day-header">
        <h2 class="day-title text-green-400">–°—Ä–µ–¥–∞</h2>
        <div class="day-homework"><span>–î–ó</span></div>
      </div>
      <div class="flex-1" id="wed"></div>
    </div>
    
    <!-- –ß–µ—Ç–≤–µ—Ä–≥ -->
    <div class="day-grid">
      <div class="day-header">
        <h2 class="day-title text-purple-400">–ß–µ—Ç–≤–µ—Ä–≥</h2>
        <div class="day-homework"><span>–î–ó</span></div>
      </div>
      <div class="flex-1" id="thu"></div>
    </div>
    
    <!-- –ü—è—Ç–Ω–∏—Ü–∞ -->
    <div class="day-grid">
      <div class="day-header">
        <h2 class="day-title text-pink-400">–ü—è—Ç–Ω–∏—Ü–∞</h2>
        <div class="day-homework"><span>–î–ó</span></div>
      </div>
      <div class="flex-1" id="fri"></div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –¥–ª—è –î–ó -->
  <div id="dzModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="modal bg-gray-800 p-6 rounded-2xl shadow-xl w-11/12 max-w-3xl relative">
      <button onclick="closeModal()" class="absolute top-2 right-2 text-2xl text-gray-400 hover:text-red-400">‚úñ</button>
      <h2 class="text-xl font-bold mb-4 text-white">–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ</h2>
      <div id="dzContent" class="prose max-w-none text-white"></div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –î–ó -->
  <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="modal bg-gray-800 p-6 rounded-2xl shadow-xl w-11/12 max-w-3xl relative">
      <button onclick="closeEditModal()" class="absolute top-2 right-2 text-2xl text-gray-400 hover:text-red-400">‚úñ</button>
      <h2 id="editSubject" class="text-xl font-bold mb-4 text-white"></h2>
      
      <textarea id="homeworkText" placeholder="–í–≤–µ–¥–∏—Ç–µ –¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ..." class="w-full p-3 border rounded mb-4 bg-gray-700 text-white border-gray-600" rows="4"></textarea>
      
      <div class="image-upload mb-4 bg-gray-700" id="imageUpload">
        <p class="text-white">üìÅ –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å—é–¥–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</p>
        <input type="file" id="imageInput" accept="image/*" class="hidden">
        <img id="uploadedImagePreview" class="uploaded-image hidden">
      </div>
      
      <div class="flex justify-end">
        <button onclick="saveHomework()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">–ì–æ—Ç–æ–≤–æ</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ —á–∞—Ç–∞ -->
  <div id="chatModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="modal bg-gray-800 p-6 rounded-2xl shadow-xl w-11/12 max-w-md relative flex flex-col h-4/5">
      <button onclick="closeChat()" class="absolute top-2 right-2 text-2xl text-gray-400 hover:text-red-400">‚úñ</button>
      <h2 class="text-xl font-bold mb-2 text-white flex items-center">
        <span>üí¨ –û–Ω–ª–∞–π–Ω-—á–∞—Ç</span>
        <span id="deleteTimer" class="ml-2 text-sm font-normal bg-blue-900 text-blue-200 px-2 py-1 rounded">
          –∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑: 6:00:00
        </span>
      </h2>
      
      <div id="chatMessages" class="flex-1 overflow-y-auto mb-2 p-2 border rounded border-gray-600 chat-container"></div>
      
      <div id="stickerPicker" class="sticker-picker hidden">
        <div class="sticker-item" onclick="sendSticker('sticker.png')"><img src="sticker.png" class="sticker-img" alt="–°—Ç–∏–∫–µ—Ä 1"></div>
        <div class="sticker-item" onclick="sendSticker('sticker1.png')"><img src="sticker1.png" class="sticker-img" alt="–°—Ç–∏–∫–µ—Ä 2"></div>
        <div class="sticker-item" onclick="sendSticker('sticker2.png')"><img src="sticker2.png" class="sticker-img" alt="–°—Ç–∏–∫–µ—Ä 3"></div>
        <div class="sticker-item" onclick="sendSticker('sticker3.png')"><img src="sticker3.png" class="sticker-img" alt="–°—Ç–∏–∫–µ—Ä 4"></div>
        <div class="sticker-item" onclick="sendSticker('sticker4.png')"><img src="sticker4.png" class="sticker-img" alt="–°—Ç–∏–∫–µ—Ä 5"></div>
        <div class="sticker-item" onclick="sendSticker('sticker5.png')"><img src="sticker5.png" class="sticker-img" alt="–°—Ç–∏–∫–µ—Ä 6"></div>
        <div class="sticker-item" onclick="sendSticker('sticker6.png')"><img src="sticker6.png" class="sticker-img" alt="–°—Ç–∏–∫–µ—Ä 7"></div>
        <div class="sticker-item" onclick="sendSticker('sticker7.png')"><img src="sticker7.png" class="sticker-img" alt="–°—Ç–∏–∫–µ—Ä 8"></div>
      </div>
      
      <div class="flex space-x-2">
        <button id="stickerToggle" onclick="toggleStickerPicker()" class="px-3 py-2 bg-gray-600 text-white rounded hover:bg-gray-500">
          üòä
        </button>
        <input id="chatInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
          class="flex-1 p-2 border rounded bg-gray-700 text-white border-gray-600"
          onkeypress="handleChatKeyPress(event)">
        <button id="sendButton" onclick="sendChatMessage()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">‚û§</button>
      </div>
      
      <div class="mt-2 text-sm text-gray-400 flex items-center justify-between">
        <span><span id="onlineCount">0</span> –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–Ω–ª–∞–π–Ω</span>
        <button id="adminUsersButton" onclick="showOnlineUsers()" class="hidden text-blue-400 hover:text-blue-300">
          ‚ùì
        </button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞ -->
  <div id="accountModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="modal bg-gray-800 p-6 rounded-2xl shadow-xl w-11/12 max-w-md relative">
      <button onclick="closeAccountModal()" class="absolute top-2 right-2 text-2xl text-gray-400 hover:text-red-400">‚úñ</button>
      
      <div id="authSection" class="auth-section">
        <div class="auth-tabs">
          <div class="auth-tab active" onclick="switchAuthTab('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
          <div class="auth-tab" onclick="switchAuthTab('login')">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</div>
        </div>
        
        <form id="registerForm" class="auth-form active">
          <input type="text" id="regUsername" placeholder="–ù–∏–∫–Ω–µ–π–º (4-12 —Å–∏–º–≤–æ–ª–æ–≤)" class="w-full p-3 border rounded mb-3 bg-gray-700 text-white border-gray-600">
          <input type="password" id="regPassword" placeholder="–ü–∞—Ä–æ–ª—å" class="w-full p-3 border rounded mb-3 bg-gray-700 text-white border-gray-600">
          <input type="password" id="regConfirmPassword" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å" class="w-full p-3 border rounded mb-3 bg-gray-700 text-white border-gray-600">
          <div class="captcha-code" id="regCaptchaCode">ABCDEF</div>
          <input type="text" id="regCaptchaInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ —Å –∫–∞—Ä—Ç–∏–Ω–∫–∏" class="w-full p-3 border rounded mb-4 bg-gray-700 text-white border-gray-600">
          <button type="button" onclick="register()" class="w-full px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
        </form>
        
        <form id="loginForm" class="auth-form">
          <input type="text" id="loginUsername" placeholder="–ù–∏–∫–Ω–µ–π–º" class="w-full p-3 border rounded mb-3 bg-gray-700 text-white border-gray-600">
          <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å" class="w-full p-3 border rounded mb-3 bg-gray-700 text-white border-gray-600">
          <div class="captcha-code" id="loginCaptchaCode">GHIJKL</div>
          <input type="text" id="loginCaptchaInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ —Å –∫–∞—Ä—Ç–∏–Ω–∫–∏" class="w-full p-3 border rounded mb-4 bg-gray-700 text-white border-gray-600">
          <button type="button" onclick="login()" class="w-full px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">–í–æ–π—Ç–∏</button>
        </form>
      </div>
      
      <div id="profileSection" class="profile-section hidden">
        <div class="profile-avatar" onclick="document.getElementById('avatarInput').click()">
          <img id="profileAvatar" src="account.png" alt="–ê–≤–∞—Ç–∞—Ä" class="w-full h-full rounded-full">
          <div class="avatar-overlay">–°–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ</div>
          <input type="file" id="avatarInput" accept="image/*" class="hidden" onchange="changeAvatar(this.files[0])">
        </div>
        
        <div class="nickname-edit">
          <span id="profileUsername" class="text-xl font-bold"></span>
          <button onclick="editNickname()" class="text-blue-400 hover:text-blue-300">‚úèÔ∏è</button>
        </div>
        
        <div id="nicknameEdit" class="hidden mt-4">
          <input type="text" id="newNickname" placeholder="–ù–æ–≤—ã–π –Ω–∏–∫–Ω–µ–π–º (4-12 —Å–∏–º–≤–æ–ª–æ–≤)" class="w-full p-3 border rounded mb-3 bg-gray-700 text-white border-gray-600">
          <button onclick="saveNickname()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button onclick="cancelEditNickname()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 ml-2">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Changelog –º–æ–¥–∞–ª–∫–∞ -->
  <div id="changelogModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="modal bg-gray-800 p-6 rounded-2xl shadow-xl w-11/12 max-w-3xl relative">
      <button onclick="closeChangelog()" class="absolute top-2 right-2 text-2xl text-gray-400 hover:text-red-400">‚úñ</button>
      <h2 class="text-xl font-bold mb-4 text-white">Changelog</h2>
      <pre class="whitespace-pre-wrap text-sm text-white">[+] Mini-Chat
[+] –î–æ–±–∞–≤–∏–ª–∏ Admin Panel
[+] –£–ª—É—á—à–∏–ª–∏ –¥–∏–∑–∞–π–Ω —á–∞—Ç–∞
[+] –£–ª—É—á—à–∏–ª–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –º–∞—Ç–æ–≤
[+] –î–æ–±–∞–≤–∏–ª–∏ —Å–∏—Å—Ç–µ–º—É –∞–∫–∫–∞—É–Ω—Ç–æ–≤</pre>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
  <div id="usersModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="modal bg-gray-800 p-6 rounded-2xl shadow-xl w-11/12 max-w-md relative">
      <button onclick="closeUsersModal()" class="absolute top-2 right-2 text-2xl text-gray-400 hover:text-red-400">‚úñ</button>
      <h2 class="text-xl font-bold mb-4 text-white">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ–Ω–ª–∞–π–Ω</h2>
      <div id="usersList" class="max-h-64 overflow-y-auto"></div>
    </div>
  </div>

  <script>
    // ==================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE ====================
    const firebaseConfig = {
      apiKey: "AIzaSyD4SjU8HuZZZwruDnXQ3Mz1l6mj9xpn8EU",
      authDomain: "school-diary-8a.firebaseapp.com",
      databaseURL: "https://school-diary-8a-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "school-diary-8a",
      storageBucket: "school-diary-8a.firebasestorage.app",
      messagingSenderId: "252043407645",
      appId: "1:252043407645:web:ebde5ca5405273a07571f4"
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let isAdmin = false;
    let homework = {};
    let currentEditingSubject = null;
    let currentEditingDay = null;
    let uploadedImage = null;
    let userName = "–ì–æ—Å—Ç—å_" + Math.floor(Math.random() * 1000);
    let chatRef = null;
    let onlineUsersRef = null;
    let userRef = null;
    let nextDeleteTime = null;
    let deleteTimerInterval = null;
    let onlineUsers = {};
    let lastMessageTime = 0;
    let messageCooldown = 5000; // 5 —Å–µ–∫—É–Ω–¥
    let isLoggedIn = false;
    let currentUser = null;
    
    const lessons = {
      mon: ["–ê–ª–≥–µ–±—Ä–∞","–†–û–í","–•–∏–º–∏—è","–ì–µ–æ–≥—Ä–∞—Ñ–∏—è","–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫","–§–∏–∑–∏–∫–∞","–ë–∏–æ–ª–æ–≥–∏—è"],
      tue: ["–ì–µ–æ–º–µ—Ç—Ä–∏—è","–¢–µ–æ—Ä–∏—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏","–§–ö","–ò—Å—Ç–æ—Ä–∏—è","–†—É—Å—Å–∫–∏–π —è–∑—ã–∫","–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞"],
      wed: ["–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫","–§–ö","–†—É—Å—Å–∫–∏–π —è–∑—ã–∫","–ê–ª–≥–µ–±—Ä–∞","–ì–µ–æ–≥—Ä–∞—Ñ–∏—è","–ò–ö–¢"],
      thu: ["–§–∏–∑–∏–∫–∞","–ì–µ–æ–º–µ—Ç—Ä–∏—è","–ú—É–∑—ã–∫–∞","–•–∏–º–∏—è","–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞","–†—É—Å—Å–∫–∏–π —è–∑—ã–∫"],
      fri: ["–û–±—â–µ—Å—Ç–≤–æ","–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è","–ê–ª–≥–µ–±—Ä–∞","–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫","–ë–∏–æ–ª–æ–≥–∏—è","–û–ë–ñ","–ò—Å—Ç–æ—Ä–∏—è"]
    };

    // –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –º–∞—Ç–æ–≤ –∏ –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏–π
    const badWords = [
      '—Å—É–∫–∞', '–±–ª—è', '—Ö—É–π', '–ø–∏–∑–¥–∞', '–µ–±–∞–Ω', '–µ–±–∞—Ç—å', '–µ–±–ª–æ', '–≥–æ–Ω–¥–æ–Ω', '–º—É–¥–∞–∫', '–ø–∏–¥–æ—Ä', 
      '–¥–æ–ª–±–æ–µ–±', '–∑–∞–ª—É–ø–∞', '—à–ª—é—Ö–∞', '–±–ª—è–¥—å', '–∞—Ö—É–µ—Ç—å', '–æ—Ö—É–µ—Ç—å', '–ø–∏–∑–¥–µ—Ü', '–µ–±–∞–ª', '–≤—ã–µ–±',
      '–≥–∞–Ω–¥–æ–Ω', '–º—É–¥–∏–ª–∞', '—Å—Å–∞–Ω–∏–Ω–∞', '—Å—Å–∞—Ç—å', '—Å—Ä–∞—Ç—å', '—Å—Ä–∞–Ω', '–¥—Ä–∏—Å—Ç', '–¥–µ—Ä—å–º–æ', '–≥–æ–≤–Ω–æ',
      '–∑–∞–ª—É–ø', '–º–∞–Ω–¥–∞', '–º—Ä–∞–∑—å', '–ø–∞–¥–ª–∞', '–ø–∞–¥–ª–æ', '—Å—É—á–∫–∞', '—Ç–≤–∞—Ä—å', '—É–±–ª—é–¥–æ–∫', '—É–µ–±–∞–Ω',
      '—Ö—É–µ—Å–æ—Å', '—Ö—É–π–Ω—è', '—à–ª—é—Ö', '–±–ª—è–¥–∏–Ω–∞', '–±–ª—è–¥—Å–∫–∏–π', '–≤—ã–µ–±—ã–≤–∞—Ç—å—Å—è', '–¥—Ä–æ—á–∏—Ç—å', '–¥—Ä–æ—á',
      '–µ–±–Ω—É—Ç—å', '–µ–±–Ω—É—Ç—ã–π', '–µ–±—É—á–∏–π', '–∑–∞–µ–±', '–∑–∞–µ–±–∞', '–Ω–∞–µ–±', '–æ—Ö—É–µ–≤–∞', '–ø–µ—Ä–µ–µ–±', '–ø–æ–¥—ä–µ–±',
      '—Ä–∞–∑—ä–µ–±', '—Å—ä–µ–±', '—É–µ–±', 'fuck', 'shit', 'bitch', 'asshole', 'dick', 'pussy', 'cunt',
      'ass', 'cock', 'whore', 'slut', 'nigger', 'nigga', 'faggot', 'retard', 'motherfucker'
    ];

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–π –∫–∞–ø—Ç—á–∏
    function generateCaptcha() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let result = '';
      for (let i = 0; i < 6; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return result;
    }

    // –ó–≤—É–∫–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
    function playSound(soundName) {
      try {
        const audio = new Audio(soundName + '.wav');
        audio.play().catch(e => console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∑–≤—É–∫:', e));
      } catch (error) {
        console.log('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–∞:', error);
      }
    }

    // ==================== –£–°–ò–õ–ï–ù–ù–´–ô –§–ò–õ–¨–¢–† –ú–ê–¢–û–í ====================
    function filterBadWords(text) {
      if (!text) return text;
      
      let filteredText = text;
      
      // –£–¥–∞–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã, —Ç–æ—á–∫–∏ –∏ –¥—Ä—É–≥–∏–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
      const cleanText = text.replace(/[\s\.\_\-]/g, '').toLowerCase();
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –æ–±—ã—á–Ω—ã–µ –º–∞—Ç—ã
      for (const word of badWords) {
        if (cleanText.includes(word)) {
          return '';
        }
        
        // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å —Ä–∞–∑–Ω—ã–º–∏ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏
        const regexPattern = word.split('').join('[\\s\\.\\_\\-]*');
        const regex = new RegExp(regexPattern, 'gi');
        if (regex.test(text.toLowerCase())) {
          return '';
        }
      }
      
      return filteredText;
    }

    // ==================== –ê–í–¢–û–£–î–ê–õ–ï–ù–ò–ï –ß–ê–¢–ê ====================
    function calculateNextDeleteTime() {
      const now = new Date();
      const krasnoyarskOffset = 7 * 60 * 60 * 1000;
      const localOffset = now.getTimezoneOffset() * 60 * 1000;
      const krasnoyarskTime = new Date(now.getTime() + localOffset + krasnoyarskOffset);
      
      const deleteHours = [6, 12, 18, 24];
      let nextDeleteHour = null;
      
      for (const hour of deleteHours) {
        if (krasnoyarskTime.getHours() < hour) {
          nextDeleteHour = hour;
          break;
        }
      }
      
      if (nextDeleteHour === null) {
        nextDeleteHour = deleteHours[0];
        krasnoyarskTime.setDate(krasnoyarskTime.getDate() + 1);
      }
      
      krasnoyarskTime.setHours(nextDeleteHour, 0, 0, 0);
      return new Date(krasnoyarskTime.getTime() - localOffset - krasnoyarskOffset);
    }
    
    function updateDeleteTimer() {
      if (!nextDeleteTime) {
        nextDeleteTime = calculateNextDeleteTime();
      }
      
      const now = new Date();
      const timeLeft = nextDeleteTime - now;
      
      if (timeLeft <= 0) {
        if (chatRef) {
          chatRef.remove();
          nextDeleteTime = calculateNextDeleteTime();
        }
        return;
      }
      
      const hours = Math.floor(timeLeft / (1000 * 60 * 60));
      const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
      
      const timerElement = document.getElementById('deleteTimer');
      if (timerElement) {
        timerElement.textContent = `–∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑: ${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      }
    }
    
    function startDeleteTimer() {
      updateDeleteTimer();
      deleteTimerInterval = setInterval(updateDeleteTimer, 1000);
    }

    // ==================== –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ====================
    function showNotification(message, type = 'success') {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = `notification ${type} show`;
      
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.classList.add('hidden'), 300);
      }, 3000);
    }

    // ==================== –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨ ====================
    function toggleAdminLogin() {
      const adminLogin = document.getElementById('adminLogin');
      adminLogin.classList.toggle('hidden');
    }

    function loginAdmin() {
      const password = document.getElementById('adminPassword').value;
      
      if (password === "7777") {
        isAdmin = true;
        document.getElementById('syncButtonContainer').classList.remove('hidden');
        document.getElementById('adminLogin').classList.add('hidden');
        document.getElementById('adminUsersButton').classList.remove('hidden');
        showNotification('‚úÖ –í—ã –≤–æ—à–ª–∏ –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä', 'success');
        renderAll();
      } else {
        showNotification('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å', 'error');
      }
      
      document.getElementById('adminPassword').value = "";
    }

    // ==================== FIREBASE ====================
    function loadData() {
      updateSyncStatus('syncing', '–ó–∞–≥—Ä—É–∑–∫–∞...');
      
      const homeworkRef = database.ref('homework');
      
      homeworkRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          homework = data;
          renderAll();
          updateSyncStatus('online', `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${new Date().toLocaleTimeString()}`);
          localStorage.setItem('diaryHomework', JSON.stringify(homework));
        } else {
          createInitialData();
        }
      }, (error) => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
        loadFromLocal();
      });
    }

    function saveData() {
      updateSyncStatus('syncing', '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...');
      
      database.ref('homework').set(homework)
        .then(() => {
          updateSyncStatus('online', '‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');
          localStorage.setItem('diaryHomework', JSON.stringify(homework));
        })
        .catch((error) => {
          console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
          updateSyncStatus('offline', '‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
          localStorage.setItem('diaryHomework', JSON.stringify(homework));
        });
    }

    function createInitialData() {
      const initialData = {};
      
      Object.keys(lessons).forEach(day => {
        initialData[day] = {};
        lessons[day].forEach(subject => {
          initialData[day][subject] = "";
        });
      });
      
      database.ref('homework').set(initialData)
        .then(() => {
          homework = initialData;
          renderAll();
        });
    }

    function loadFromLocal() {
      const saved = localStorage.getItem('diaryHomework');
      if (saved) {
        homework = JSON.parse(saved);
        renderAll();
        updateSyncStatus('offline', '–õ–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
      }
    }

    function updateSyncStatus(status, message) {
      const statusElement = document.getElementById('onlineStatus');
      const syncStatus = document.getElementById('syncStatus');
      
      if (syncStatus) syncStatus.textContent = message;
      
      if (statusElement) {
        let html = '';
        switch(status) {
          case 'online': html = '<span class="online-dot online"></span><span>–æ–Ω–ª–∞–π–Ω</span>'; break;
          case 'offline': html = '<span class="online-dot offline"></span><span>–æ—Ñ—Ñ–ª–∞–π–Ω</span>'; break;
          case 'syncing': html = '<span class="online-dot syncing"></span><span>—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...</span>'; break;
        }
        statusElement.innerHTML = html;
      }
    }

    function forceSync() {
      const button = document.querySelector('#syncButtonContainer button');
      const originalText = button.textContent;
      
      button.textContent = "‚è≥ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...";
      button.disabled = true;
      
      loadData();
      
      setTimeout(() => {
        button.textContent = originalText;
        button.disabled = false;
      }, 1000);
    }

    // ==================== –ß–ê–¢ ====================
    function setupChat() {
      chatRef = database.ref('chat/messages');
      onlineUsersRef = database.ref('onlineUsers');
      userRef = onlineUsersRef.push();
      
      const savedName = localStorage.getItem('chatUserName');
      if (savedName) {
        userName = savedName;
      } else {
        userName = "–ì–æ—Å—Ç—å_" + Math.floor(Math.random() * 1000);
        localStorage.setItem('chatUserName', userName);
      }
      
      userRef.set({
        name: userName,
        lastSeen: firebase.database.ServerValue.TIMESTAMP
      });
      
      window.addEventListener('beforeunload', () => {
        userRef.remove();
      });
      
      onlineUsersRef.on('value', (snapshot) => {
        onlineUsers = snapshot.val() || {};
        const count = Object.keys(onlineUsers).length;
        document.getElementById('onlineCount').textContent = count;
      });
      
      loadChatMessages();
      startDeleteTimer();
    }
    
    function loadChatMessages() {
      chatRef.limitToLast(50).on('value', (snapshot) => {
        const messages = snapshot.val();
        const messagesContainer = document.getElementById('chatMessages');
        messagesContainer.innerHTML = '';
        
        if (messages) {
          Object.values(messages).forEach(msg => {
            if (msg && (msg.text || msg.sticker)) {
              if (msg.sticker) {
                addStickerToChat(msg.name, msg.sticker, msg.timestamp, msg.name === userName);
              } else {
                addMessageToChat(msg.name, msg.text, msg.timestamp, msg.name === userName);
              }
            }
          });
          
          setTimeout(() => {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
          }, 100);
        }
      });
    }
    
    function addMessageToChat(name, text, timestamp, isOwn = false) {
      const messagesContainer = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message-container ${isOwn ? 'own' : ''}`;
      
      const time = new Date(timestamp);
      const timeStr = time.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      
      messageDiv.innerHTML = `
        <img src="account.png" class="avatar" alt="${name}">
        <div class="message-bubble ${isOwn ? 'own' : 'other'}">
          <div class="message-sender">${isOwn ? '–í—ã' : name}</div>
          <div>${text}</div>
          <div class="message-time">${timeStr}</div>
        </div>
      `;
      
      messagesContainer.appendChild(messageDiv);
    }
    
    function addStickerToChat(name, stickerUrl, timestamp, isOwn = false) {
      const messagesContainer = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message-container ${isOwn ? 'own' : ''}`;
      
      const time = new Date(timestamp);
      const timeStr = time.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      
      messageDiv.innerHTML = `
        <img src="account.png" class="avatar" alt="${name}">
        <div class="message-bubble ${isOwn ? 'own' : 'other'}" style="background: none; padding: 0;">
          <div class="message-sender">${isOwn ? '–í—ã' : name}</div>
          <img src="${stickerUrl}" class="chat-sticker">
          <div class="message-time">${timeStr}</div>
        </div>
      `;
      
      messagesContainer.appendChild(messageDiv);
    }
    
    function sendChatMessage() {
      const now = Date.now();
      if (now - lastMessageTime < messageCooldown) {
        const timeLeft = Math.ceil((messageCooldown - (now - lastMessageTime)) / 1000);
        showNotification(`‚ùå –ü–æ–¥–æ–∂–¥–∏—Ç–µ ${timeLeft} —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π`, 'error');
        return;
      }
      
      const input = document.getElementById('chatInput');
      let text = input.value.trim();
      
      if (text) {
        // –§–∏–ª—å—Ç—Ä—É–µ–º –º–∞—Ç—ã
        const filteredText = filterBadWords(text);
        if (filteredText === '') {
          showNotification('‚ùå –°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ —Å–ª–æ–≤–∞', 'error');
          input.value = '';
          return;
        }
        
        chatRef.push({
          name: userName,
          text: filteredText,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        });
        
        input.value = '';
        lastMessageTime = now;
        updateSendButtonCooldown();
      }
    }
    
    function sendSticker(stickerUrl) {
      const now = Date.now();
      if (now - lastMessageTime < messageCooldown) {
        const timeLeft = Math.ceil((messageCooldown - (now - lastMessageTime)) / 1000);
        showNotification(`‚ùå –ü–æ–¥–æ–∂–¥–∏—Ç–µ ${timeLeft} —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π`, 'error');
        return;
      }
      
      chatRef.push({
        name: userName,
        sticker: stickerUrl,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      });
      
      toggleStickerPicker();
      lastMessageTime = now;
      updateSendButtonCooldown();
    }
    
    function updateSendButtonCooldown() {
      const button = document.getElementById('sendButton');
      button.disabled = true;
      button.textContent = '5';
      
      let secondsLeft = 5;
      const countdown = setInterval(() => {
        secondsLeft--;
        button.textContent = secondsLeft.toString();
        
        if (secondsLeft === 0) {
          clearInterval(countdown);
          button.disabled = false;
          button.textContent = '‚û§';
        }
      }, 1000);
    }
    
    function toggleStickerPicker() {
      const stickerPicker = document.getElementById('stickerPicker');
      stickerPicker.classList.toggle('hidden');
    }
    
    function handleChatKeyPress(event) {
      if (event.key === 'Enter') {
        sendChatMessage();
      }
    }
    
    function toggleChat() {
      const chatModal = document.getElementById('chatModal');
      if (chatModal.classList.contains('hidden')) {
        openChat();
      } else {
        closeChat();
      }
    }
    
    function openChat() {
      document.getElementById('chatModal').classList.remove('hidden');
      setTimeout(() => {
        document.querySelector('#chatModal .modal').classList.add('show');
        document.getElementById('chatInput').focus();
      }, 10);
      
      if (userRef) {
        userRef.update({
          lastSeen: firebase.database.ServerValue.TIMESTAMP
        });
      }
    }
    
    function closeChat() {
      const modal = document.querySelector('#chatModal .modal');
      modal.classList.remove('show');
      setTimeout(() => document.getElementById('chatModal').classList.add('hidden'), 250);
      document.getElementById('stickerPicker').classList.add('hidden');
    }

    // ==================== –°–ò–°–¢–ï–ú–ê –ê–ö–ö–ê–£–ù–¢–û–í ====================
    function openAccountModal() {
      document.getElementById('accountModal').classList.remove('hidden');
      setTimeout(() => {
        document.querySelector('#accountModal .modal').classList.add('show');
      }, 10);
      
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ –∫–∞–ø—Ç—á–∏
      document.getElementById('regCaptchaCode').textContent = generateCaptcha();
      document.getElementById('loginCaptchaCode').textContent = generateCaptcha();
    }
    
    function closeAccountModal() {
      const modal = document.querySelector('#accountModal .modal');
      modal.classList.remove('show');
      setTimeout(() => document.getElementById('accountModal').classList.add('hidden'), 250);
    }
    
    function switchAuthTab(tab) {
      document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
      
      document.querySelector(`.auth-tab:${tab === 'register' ? 'first' : 'last'}-child`).classList.add('active');
      document.getElementById(tab === 'register' ? 'registerForm' : 'loginForm').classList.add('active');
    }
    
    function register() {
      const username = document.getElementById('regUsername').value.trim();
      const password = document.getElementById('regPassword').value;
      const confirmPassword = document.getElementById('regConfirmPassword').value;
      const captchaInput = document.getElementById('regCaptchaInput').value;
      const captchaCode = document.getElementById('regCaptchaCode').textContent;
      
      if (username.length < 4 || username.length > 12) {
        showNotification('‚ùå –ù–∏–∫–Ω–µ–π–º –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 4 –¥–æ 12 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
        return;
      }
      
      if (password.length < 6) {
        showNotification('‚ùå –ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
        return;
      }
      
      if (password !== confirmPassword) {
        showNotification('‚ùå –ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç', 'error');
        return;
      }
      
      if (captchaInput !== captchaCode) {
        showNotification('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –∫–∞–ø—Ç—á–∏', 'error');
        return;
      }
      
      // –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ª–æ–≥–∏–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Firebase Auth
      // –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –∏–º–∏—Ç–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—É—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
      showNotification('‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!', 'success');
      isLoggedIn = true;
      currentUser = { username, avatar: 'account.png' };
      
      // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å
      document.getElementById('authSection').classList.add('hidden');
      document.getElementById('profileSection').classList.remove('hidden');
      document.getElementById('profileUsername').textContent = username;
      document.getElementById('profileAvatar').src = 'account.png';
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
      localStorage.setItem('currentUser', JSON.stringify(currentUser));
    }
    
    function login() {
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;
      const captchaInput = document.getElementById('loginCaptchaInput').value;
      const captchaCode = document.getElementById('loginCaptchaCode').textContent;
      
      if (captchaInput !== captchaCode) {
        showNotification('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –∫–∞–ø—Ç—á–∏', 'error');
        return;
      }
      
      // –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ª–æ–≥–∏–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Firebase Auth
      // –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –∏–º–∏—Ç–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥
      showNotification('‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!', 'success');
      isLoggedIn = true;
      currentUser = { username, avatar: 'account.png' };
      
      // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å
      document.getElementById('authSection').classList.add('hidden');
      document.getElementById('profileSection').classList.remove('hidden');
      document.getElementById('profileUsername').textContent = username;
      document.getElementById('profileAvatar').src = 'account.png';
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
      localStorage.setItem('currentUser', JSON.stringify(currentUser));
    }
    
    function changeAvatar(file) {
      if (!file || !file.type.startsWith('image/')) {
        showNotification('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ', 'error');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = (e) => {
        document.getElementById('profileAvatar').src = e.target.result;
        if (currentUser) {
          currentUser.avatar = e.target.result;
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
        }
        showNotification('‚úÖ –ê–≤–∞—Ç–∞—Ä –∏–∑–º–µ–Ω—ë–Ω!', 'success');
      };
      reader.readAsDataURL(file);
    }
    
    function editNickname() {
      document.getElementById('nicknameEdit').classList.remove('hidden');
      document.getElementById('newNickname').value = document.getElementById('profileUsername').textContent;
    }
    
    function saveNickname() {
      const newNickname = document.getElementById('newNickname').value.trim();
      
      if (newNickname.length < 4 || newNickname.length > 12) {
        showNotification('‚ùå –ù–∏–∫–Ω–µ–π–º –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 4 –¥–æ 12 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
        return;
      }
      
      document.getElementById('profileUsername').textContent = newNickname;
      document.getElementById('nicknameEdit').classList.add('hidden');
      
      if (currentUser) {
        currentUser.username = newNickname;
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
      }
      
      showNotification('‚úÖ –ù–∏–∫–Ω–µ–π–º –∏–∑–º–µ–Ω—ë–Ω!', 'success');
    }
    
    function cancelEditNickname() {
      document.getElementById('nicknameEdit').classList.add('hidden');
    }

    // ==================== –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò –û–ù–õ–ê–ô–ù ====================
    function showOnlineUsers() {
      if (!isAdmin) return;
      
      const usersList = document.getElementById('usersList');
      usersList.innerHTML = '';
      
      Object.entries(onlineUsers).forEach(([key, user]) => {
        if (user.name) {
          const userElement = document.createElement('div');
          userElement.className = 'flex items-center justify-between p-3 border-b border-gray-600';
          userElement.innerHTML = `
            <div class="flex items-center gap-3">
              <img src="account.png" class="w-8 h-8 rounded-full" alt="${user.name}">
              <span>${user.name}</span>
            </div>
            <span class="text-green-400 text-sm">online</span>
          `;
          usersList.appendChild(userElement);
        }
      });
      
      document.getElementById('usersModal').classList.remove('hidden');
      setTimeout(() => {
        document.querySelector('#usersModal .modal').classList.add('show');
      }, 10);
    }
    
    function closeUsersModal() {
      const modal = document.querySelector('#usersModal .modal');
      modal.classList.remove('show');
      setTimeout(() => document.getElementById('usersModal').classList.add('hidden'), 250);
    }

    // ==================== –†–ï–ù–î–ï–†–ò–ù–ì ====================
    function renderLessons(containerId, daySubjects) {
      const container = document.getElementById(containerId);
      container.innerHTML = "";
      
      daySubjects.forEach(subject => {
        const row = document.createElement("div");
        row.className = "subject-row flex justify-between items-center p-3";
        row.onclick = () => {};
        
        const left = document.createElement("div");
        left.className = "flex-1 pr-2";
        left.textContent = subject;
        
        const right = document.createElement("div");
        right.className = "flex items-center space-x-2";
        
        const currentHW = homework[containerId] && homework[containerId][subject];
        if (currentHW) {
          const dzIcon = document.createElement("span");
          dzIcon.className = "text-yellow-300 text-sm cursor-pointer";
          dzIcon.textContent = "üìù";
          dzIcon.title = "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –î–ó";
          dzIcon.onclick = (e) => {
            e.stopPropagation();
            openModal(subject, currentHW);
          };
          right.appendChild(dzIcon);
        }
        
        if (isAdmin) {
          const editBtn = document.createElement("button");
          editBtn.className = "text-blue-300 hover:text-blue-100 text-sm";
          editBtn.textContent = "‚úèÔ∏è";
          editBtn.title = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –î–ó";
          editBtn.onclick = (e) => {
            e.stopPropagation();
            editHW(subject, containerId);
          };
          right.appendChild(editBtn);
        }
        
        row.appendChild(left);
        row.appendChild(right);
        container.appendChild(row);
      });
    }

    function renderAll() {
      renderLessons("mon", lessons.mon);
      renderLessons("tue", lessons.tue);
      renderLessons("wed", lessons.wed);
      renderLessons("thu", lessons.thu);
      renderLessons("fri", lessons.fri);
      document.getElementById('syncButtonContainer').classList.toggle('hidden', !isAdmin);
      document.getElementById('adminUsersButton').classList.toggle('hidden', !isAdmin);
    }

    function editHW(subject, day) {
      currentEditingSubject = subject;
      currentEditingDay = day;
      const currentHW = homework[day] && homework[day][subject] || "";
      const textOnly = currentHW.replace(/!\[Image\]\(data:image\/[^)]+\)/g, '').trim();
      
      document.getElementById('editSubject').textContent = subject;
      document.getElementById('homeworkText').value = textOnly;
      document.getElementById('uploadedImagePreview').classList.add('hidden');
      uploadedImage = null;
      
      openEditModal();
    }

    function saveHomework() {
      const text = document.getElementById('homeworkText').value;
      
      if (!homework[currentEditingDay]) {
        homework[currentEditingDay] = {};
      }
      
      let hwContent = text;
      if (uploadedImage) {
        hwContent += `\n\n![Image](${uploadedImage})`;
      }
      
      homework[currentEditingDay][currentEditingSubject] = hwContent;
      saveData();
      closeEditModal();
      renderAll();
    }

    // ==================== –û–ë–†–ê–ë–û–¢–ö–ê –ö–û–ù–¢–ï–ù–¢–ê ====================
    function formatContent(content) {
      if (!content) return '<span class="text-gray-500">–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ –Ω–µ –∑–∞–¥–∞–Ω–æ</span>';
      
      let formattedContent = content;
      formattedContent = formattedContent.replace(
        /(https?:\/\/[^\s]+)/g, 
        '<a href="$1" target="_blank" class="content-link">$1</a>'
      );
      formattedContent = formattedContent.replace(
        /!\[Image\]\((data:image\/[^)]+)\)/g,
        '<img src="$1" class="content-image" alt="–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">'
      );
      formattedContent = formattedContent.replace(/\n/g, '<br>');
      
      return formattedContent;
    }

    // ==================== –ú–û–î–ê–õ–ö–ò ====================
    function openModal(subject, content) {
      document.getElementById("dzContent").innerHTML = `
        <h3 class="font-semibold text-lg mb-2">${subject}</h3>
        <div class="whitespace-pre-wrap">${formatContent(content)}</div>
      `;
      document.getElementById("dzModal").classList.remove("hidden");
      setTimeout(() => document.querySelector("#dzModal .modal").classList.add("show"), 10);
    }

    function closeModal() {
      const modal = document.querySelector("#dzModal .modal");
      modal.classList.remove("show");
      setTimeout(() => document.getElementById("dzModal").classList.add("hidden"), 250);
    }

    function openEditModal() {
      document.getElementById("editModal").classList.remove("hidden");
      setTimeout(() => document.querySelector("#editModal .modal").classList.add("show"), 10);
    }

    function closeEditModal() {
      const modal = document.querySelector("#editModal .modal");
      modal.classList.remove("show");
      setTimeout(() => document.getElementById("editModal").classList.add("hidden"), 250);
    }

    function openChangelog() {
      document.getElementById("changelogModal").classList.remove("hidden");
      setTimeout(() => document.querySelector("#changelogModal .modal").classList.add("show"), 10);
    }

    function closeChangelog() {
      const modal = document.querySelector("#changelogModal .modal");
      modal.classList.remove("show");
      setTimeout(() => document.getElementById("changelogModal").classList.add("hidden"), 250);
    }

    // ==================== –ó–ê–ì–†–£–ó–ö–ê –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô ====================
    function setupImageUpload() {
      const uploadArea = document.getElementById('imageUpload');
      const fileInput = document.getElementById('imageInput');
      const imagePreview = document.getElementById('uploadedImagePreview');
      
      uploadArea.addEventListener('click', () => {
        fileInput.click();
      });
      
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });
      
      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
      });
      
      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleImageUpload(files[0]);
        }
      });
      
      fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          handleImageUpload(e.target.files[0]);
        }
      });
    }
    
    function handleImageUpload(file) {
      if (!file.type.startsWith('image/')) {
        showNotification('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ', 'error');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = (e) => {
        uploadedImage = e.target.result;
        const imagePreview = document.getElementById('uploadedImagePreview');
        imagePreview.src = uploadedImage;
        imagePreview.classList.remove('hidden');
      };
      reader.readAsDataURL(file);
    }

    // ==================== –ó–ê–ü–£–°–ö ====================
    window.onload = () => {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
      const savedUser = localStorage.getItem('currentUser');
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        isLoggedIn = true;
        userName = currentUser.username;
      }
      
      loadData();
      setupImageUpload();
      setupChat();
      
      window.addEventListener('online', loadData);
      window.addEventListener('offline', () => {
        updateSyncStatus('offline', '–û—Ñ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º');
      });
    };

    window.addEventListener('click', (e) => {
      if (e.target.id === 'dzModal') closeModal();
      if (e.target.id === 'editModal') closeEditModal();
      if (e.target.id === 'chatModal') closeChat();
      if (e.target.id === 'changelogModal') closeChangelog();
      if (e.target.id === 'usersModal') closeUsersModal();
      if (e.target.id === 'accountModal') closeAccountModal();
    });
  </script>
</body>
</html>