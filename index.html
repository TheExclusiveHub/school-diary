<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–î–Ω–µ–≤–Ω–∏–∫</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <style>
    body {
      background-color: #1f2937;
      color: #f3f4f6;
    }
    .modal { 
      opacity: 0; transform: scale(0.97); 
      transition: opacity 0.25s ease, transform 0.25s ease; 
    }
    .modal.show { opacity: 1; transform: scale(1); }
    .online-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
    .online { background-color: #10B981; }
    .offline { background-color: #EF4444; }
    .away { background-color: #F59E0B; }
    
    /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
    .notification {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 24px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .notification.show {
      opacity: 1;
    }
    .notification.success {
      background-color: #10B981;
    }
    .notification.error {
      background-color: #EF4444;
    }
    .notification.warning {
      background-color: #F59E0B;
    }

    /* –°—Ç–∏–ª—å –¥–ª—è –ø–æ–ª—è –ø–∞—Ä–æ–ª—è */
    #adminPassword {
      color: black;
      background-color: white;
    }

    .subject-row {
      cursor: pointer;
      transition: background-color 0.2s;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .subject-row:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .subject-row:last-child {
      border-bottom: none;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */
    .image-upload {
      border: 2px dashed #ccc;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.3s;
    }

    .image-upload:hover {
      border-color: #3b82f6;
    }

    .image-upload.dragover {
      border-color: #3b82f6;
      background-color: #f0f9ff;
    }

    .uploaded-image {
      max-width: 100%;
      max-height: 200px;
      margin-top: 10px;
      border-radius: 4px;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Å—ã–ª–æ–∫ –≤ –∫–æ–Ω—Ç–µ–Ω—Ç–µ */
    .content-link {
      color: #3b82f6;
      text-decoration: underline;
    }

    .content-link:hover {
      color: #2563eb;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –∫–æ–Ω—Ç–µ–Ω—Ç–µ */
    .content-image {
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
      margin: 10px 0;
      display: block;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —á–∞—Ç–∞ */
    .chat-container {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .message-container {
      display: flex;
      align-items: flex-end;
      gap: 6px;
      max-width: 100%;
    }
    .message-container.own {
      flex-direction: row-reverse;
    }
    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      flex-shrink: 0;
      object-fit: cover;
    }
    .message-bubble {
      max-width: 70%;
      padding: 8px 12px;
      border-radius: 18px;
      position: relative;
      font-size: 14px;
      line-height: 1.4;
    }
    .message-bubble.other {
      background: #374151;
    }
    .message-bubble.own {
      background: #3b82f6;
    }
    .message-sender {
      font-weight: 600;
      font-size: 12px;
      margin-bottom: 2px;
      color: #9ca3af;
    }
    .message-time {
      font-size: 11px;
      color: #6b7280;
      text-align: right;
      margin-top: 2px;
    }
    .chat-sticker {
      max-width: 120px;
      max-height: 120px;
      border-radius: 8px;
    }
    
    /* –°—Ç–∏–∫–µ—Ä—ã */
    .sticker-picker {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-top: 10px;
      padding: 10px;
      border-radius: 8px;
      background-color: #374151;
      max-height: 200px;
      overflow-y: auto;
    }
    .sticker-item {
      cursor: pointer;
      padding: 5px;
      border-radius: 8px;
      transition: background-color 0.2s;
    }
    .sticker-item:hover {
      background-color: #4b5563;
    }
    .sticker-img {
      width: 100%;
      height: auto;
      border-radius: 5px;
    }

    /* –°–µ—Ç–∫–∞ –¥–Ω–µ–π */
    .day-grid {
      background-color: #374151;
      color: white;
      border-radius: 16px;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .day-header {
      display: flex;
      border-bottom: 1px solid #4b5563;
      background-color: #1f2937;
    }
    .day-title {
      font-weight: bold;
      font-size: 18px;
      padding: 12px;
      flex: 1;
    }
    .day-homework {
      display: flex;
      align-items: center;
      border-left: 1px solid #4b5563;
      padding: 0 12px;
      background-color: #1f2937;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∞–∫–∫–∞—É–Ω—Ç–∞ */
    .auth-tabs {
      display: flex;
      border-bottom: 1px solid #4b5563;
      margin-bottom: 20px;
    }
    .auth-tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      opacity: 0.7;
    }
    .auth-tab.active {
      background-color: #3b82f6;
      color: white;
      opacity: 1;
    }
    .auth-form {
      display: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .auth-form.active {
      display: block;
      opacity: 1;
    }
    .profile-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      margin: 0 auto 20px;
      position: relative;
      cursor: pointer;
    }
    .avatar-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 5px;
      text-align: center;
      opacity: 0;
      transition: opacity 0.3s;
      border-radius: 0 0 50% 50%;
    }
    .profile-avatar:hover .avatar-overlay {
      opacity: 1;
    }
    .nickname-display {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    .captcha-code {
      font-family: monospace;
      font-size: 24px;
      letter-spacing: 8px;
      background: linear-gradient(45deg, #3b82f6, #8b5cf6);
      padding: 10px 20px;
      border-radius: 8px;
      margin: 10px 0;
      user-select: none;
    }
    .user-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      border-bottom: 1px solid #4b5563;
    }
    .user-status:last-child {
      border-bottom: none;
    }
    .confirm-dialog {
      background: #1f2937;
      border: 2px solid #3b82f6;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }
    .password-container {
      position: relative;
    }
    .password-toggle {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      background: none;
      border: none;
      color: #9ca3af;
    }
    .blur-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      border-radius: 16px;
    }
    .blur-text {
      color: white;
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      padding: 20px;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 12px;
      max-width: 80%;
    }
    .backup-code {
      font-family: monospace;
      font-size: 16px;
      background: #1f2937;
      padding: 10px;
      border-radius: 6px;
      margin: 5px 0;
      text-align: center;
      border: 1px solid #374151;
    }
    .admin-ip {
      color: #3b82f6;
      font-weight: bold;
    }
    .user-list-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px;
      border-bottom: 1px solid #4b5563;
    }
    .user-list-item:last-child {
      border-bottom: none;
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .delete-user-btn {
      color: #EF4444;
      cursor: pointer;
      padding: 5px;
    }
    .delete-user-btn:hover {
      background-color: rgba(239, 68, 68, 0.1);
      border-radius: 4px;
    }
  </style>
</head>
<body class="min-h-screen p-6">

  <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
  <div id="notification" class="notification hidden"></div>

  <!-- –®–∞–ø–∫–∞ -->
  <div class="flex justify-center items-center mb-4 relative">
    <h1 class="text-2xl font-bold">üìö –î–Ω–µ–≤–Ω–∏–∫ üìö</h1>
    <div id="syncStatus" class="absolute right-4 top-0 text-sm text-gray-400">
      –ó–∞–≥—Ä—É–∑–∫–∞...
    </div>
  </div>

  <!-- –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å -->
  <div class="absolute top-14 left-4 flex flex-col items-start z-40">
    <button onclick="toggleAdminLogin()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">–ê–¥–º–∏–Ω</button>
    <div id="adminLogin" class="mt-2 space-x-2 flex justify-center items-center hidden bg-gray-700 p-3 rounded shadow-lg">
      <input id="adminPassword" type="password" placeholder="–ü–∞—Ä–æ–ª—å" class="border p-2 rounded w-32">
      <button onclick="loginAdmin()" class="px-3 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition-colors">–í–æ–π—Ç–∏</button>
      <button onclick="deleteAllAccounts()" class="px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∞–∫–∫–∞—É–Ω—Ç—ã</button>
    </div>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤) -->
  <div id="syncButtonContainer" class="absolute top-14 left-24 flex flex-col items-start z-40 hidden">
    <button onclick="forceSync()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition-colors">
      üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å
    </button>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞ -->
  <div class="fixed bottom-4 left-4">
    <button onclick="openAccountModal()" class="w-14 h-14 bg-gray-600 rounded-full shadow-lg flex items-center justify-center hover:bg-gray-500 transition-colors">
      <img src="account.png" alt="–ê–∫–∫–∞—É–Ω—Ç" class="w-8 h-8">
    </button>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∞ —á–∞—Ç–∞ -->
  <div class="fixed bottom-4 right-4">
    <button id="chatButton" onclick="toggleChat()" class="w-14 h-14 bg-blue-500 text-white rounded-full shadow-lg flex items-center justify-center hover:bg-blue-600 transition-colors">
      üí¨
    </button>
  </div>

  <!-- Changelog —Å—Å—ã–ª–∫–∞ -->
  <div class="fixed top-2 right-4 text-gray-400 text-sm text-right">
    <a href="#" onclick="openChangelog()" class="text-blue-400 hover:text-blue-300 underline">Changelog</a>
  </div>

  <!-- –°–µ—Ç–∫–∞ –¥–Ω–µ–π -->
  <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mt-20">
    <!-- –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ -->
    <div class="day-grid">
      <div class="day-header">
        <h2 class="day-title text-red-400">–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</h2>
        <div class="day-homework"><span>–î–ó</span></div>
      </div>
      <div class="flex-1" id="mon"></div>
    </div>
    
    <!-- –í—Ç–æ—Ä–Ω–∏–∫ -->
    <div class="day-grid">
      <div class="day-header">
        <h2 class="day-title text-blue-400">–í—Ç–æ—Ä–Ω–∏–∫</h2>
        <div class="day-homework"><span>–î–ó</span></div>
      </div>
      <div class="flex-1" id="tue"></div>
    </div>
    
    <!-- –°—Ä–µ–¥–∞ -->
    <div class="day-grid">
      <div class="day-header">
        <h2 class="day-title text-green-400">–°—Ä–µ–¥–∞</h2>
        <div class="day-homework"><span>–î–ó</span></div>
      </div>
      <div class="flex-1" id="wed"></div>
    </div>
    
    <!-- –ß–µ—Ç–≤–µ—Ä–≥ -->
    <div class="day-grid">
      <div class="day-header">
        <h2 class="day-title text-purple-400">–ß–µ—Ç–≤–µ—Ä–≥</h2>
        <div class="day-homework"><span>–î–ó</span></div>
      </div>
      <div class="flex-1" id="thu"></div>
    </div>
    
    <!-- –ü—è—Ç–Ω–∏—Ü–∞ -->
    <div class="day-grid">
      <div class="day-header">
        <h2 class="day-title text-pink-400">–ü—è—Ç–Ω–∏—Ü–∞</h2>
        <div class="day-homework"><span>–î–ó</span></div>
      </div>
      <div class="flex-1" id="fri"></div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –¥–ª—è –î–ó -->
  <div id="dzModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="modal bg-gray-800 p-6 rounded-2xl shadow-xl w-11/12 max-w-3xl relative">
      <button onclick="closeModal()" class="absolute top-2 right-2 text-2xl text-gray-400 hover:text-red-400">‚úñ</button>
      <h2 class="text-xl font-bold mb-4 text-white">–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ</h2>
      <div id="dzContent" class="prose max-w-none text-white"></div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –î–ó -->
  <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="modal bg-gray-800 p-6 rounded-2xl shadow-xl w-11/12 max-w-3xl relative">
      <button onclick="closeEditModal()" class="absolute top-2 right-2 text-2xl text-gray-400 hover:text-red-400">‚úñ</button>
      <h2 id="editSubject" class="text-xl font-bold mb-4 text-white"></h2>
      
      <textarea id="homeworkText" placeholder="–í–≤–µ–¥–∏—Ç–µ –¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ..." class="w-full p-3 border rounded mb-4 bg-gray-700 text-white border-gray-600" rows="4"></textarea>
      
      <div class="image-upload mb-4 bg-gray-700" id="imageUpload">
        <p class="text-white">üìÅ –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å—é–¥–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</p>
        <input type="file" id="imageInput" accept="image/*" class="hidden">
        <img id="uploadedImagePreview" class="uploaded-image hidden">
      </div>
      
      <div class="flex justify-end">
        <button onclick="saveHomework()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">–ì–æ—Ç–æ–≤–æ</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ —á–∞—Ç–∞ -->
  <div id="chatModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="modal bg-gray-800 p-6 rounded-2xl shadow-xl w-11/12 max-w-md relative flex flex-col h-4/5">
      <button onclick="closeChat()" class="absolute top-2 right-2 text-2xl text-gray-400 hover:text-red-400">‚úñ</button>
      <h2 class="text-xl font-bold mb-2 text-white flex items-center">
        <span>üí¨ –û–Ω–ª–∞–π–Ω-—á–∞—Ç</span>
        <span id="deleteTimer" class="ml-2 text-sm font-normal bg-blue-900 text-blue-200 px-2 py-1 rounded">
          –∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑: 6:00:00
        </span>
      </h2>
      
      <div id="chatMessages" class="flex-1 overflow-y-auto mb-2 p-2 border rounded border-gray-600 chat-container"></div>
      
      <div id="stickerPicker" class="sticker-picker hidden">
        <div class="sticker-item" onclick="sendSticker('sticker.png')"><img src="sticker.png" class="sticker-img" alt="–°—Ç–∏–∫–µ—Ä 1"></div>
        <div class="sticker-item" onclick="sendSticker('sticker1.png')"><img src="sticker1.png" class="sticker-img" alt="–°—Ç–∏–∫–µ—Ä 2"></div>
        <div class="sticker-item" onclick="sendSticker('sticker2.png')"><img src="sticker2.png" class="sticker-img" alt="–°—Ç–∏–∫–µ—Ä 3"></div>
        <div class="sticker-item" onclick="sendSticker('sticker3.png')"><img src="sticker3.png" class="sticker-img" alt="–°—Ç–∏–∫–µ—Ä 4"></div>
        <div class="sticker-item" onclick="sendSticker('sticker4.png')"><img src="sticker4.png' class="sticker-img" alt="–°—Ç–∏–∫–µ—Ä 5"></div>
        <div class="sticker-item" onclick="sendSticker('sticker5.png')"><img src="sticker5.png" class="sticker-img" alt="–°—Ç–∏–∫–µ—Ä 6"></div>
        <div class="sticker-item" onclick="sendSticker('sticker6.png')"><img src="sticker6.png" class="sticker-img" alt="–°—Ç–∏–∫–µ—Ä 7"></div>
        <div class="sticker-item" onclick="sendSticker('sticker7.png')"><img src="sticker7.png" class="sticker-img" alt="–°—Ç–∏–∫–µ—Ä 8"></div>
      </div>
      
      <div class="flex space-x-2">
        <button id="stickerToggle" onclick="toggleStickerPicker()" class="px-3 py-2 bg-gray-600 text-white rounded hover:bg-gray-500">
          üòä
        </button>
        <input id="chatInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
          class="flex-1 p-2 border rounded bg-gray-700 text-white border-gray-600"
          onkeypress="handleChatKeyPress(event)">
        <button id="sendButton" onclick="sendChatMessage()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">‚û§</button>
      </div>
      
      <div class="mt-2 text-sm text-gray-400 flex items-center justify-between">
        <span><span id="onlineCount">0</span> –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–Ω–ª–∞–π–Ω</span>
        <button id="adminUsersButton" onclick="showOnlineUsers()" class="hidden text-blue-400 hover:text-blue-300">
          ‚ùì
        </button>
      </div>

      <!-- –ë–ª—é—Ä –æ–≤–µ—Ä–ª–µ–π –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
      <div id="chatBlurOverlay" class="blur-overlay hidden">
        <div class="blur-text">
          –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ —á–∏—Ç–∞—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç –ø–æ–∫–∞ –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å.
        </div>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞ -->
  <div id="accountModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="modal bg-gray-800 p-6 rounded-2xl shadow-xl w-11/12 max-w-md relative">
      <button onclick="closeAccountModal()" class="absolute top-2 right-2 text-2xl text-gray-400 hover:text-red-400">‚úñ</button>
      
      <div id="authSection" class="auth-section">
        <div class="auth-tabs">
          <div class="auth-tab active" onclick="switchAuthTab('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
          <div class="auth-tab" onclick="switchAuthTab('login')">–í—Ö–æ–¥</div>
        </div>
        
        <form id="registerForm" class="auth-form active">
          <input type="text" id="regNickname" placeholder="–ù–∏–∫–Ω–µ–π–º (4-12 —Å–∏–º–≤–æ–ª–æ–≤)" class="w-full p-3 border rounded mb-3 bg-gray-700 text-white border-gray-600">
          
          <div class="password-container mb-3">
            <input type="password" id="regPassword" placeholder="–ü–∞—Ä–æ–ª—å" class="w-full p-3 border rounded bg-gray-700 text-white border-gray-600 pr-10">
            <button type="button" class="password-toggle" onclick="togglePasswordVisibility('regPassword', 'regPasswordToggle')">
              <span id="regPasswordToggle">üëÅÔ∏è</span>
            </button>
          </div>
          
          <div class="password-container mb-3">
            <input type="password" id="regConfirmPassword" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å" class="w-full p-3 border rounded bg-gray-700 text-white border-gray-600 pr-10">
            <button type="button" class="password-toggle" onclick="togglePasswordVisibility('regConfirmPassword', 'regConfirmPasswordToggle')">
              <span id="regConfirmPasswordToggle">üëÅÔ∏è</span>
            </button>
          </div>
          
          <div class="captcha-code" id="regCaptchaCode">ABCDEF</div>
          <input type="text" id="regCaptchaInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ —Å –∫–∞—Ä—Ç–∏–Ω–∫–∏" class="w-full p-3 border rounded mb-4 bg-gray-700 text-white border-gray-600">
          <button type="button" onclick="showRegisterConfirm()" class="w-full px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
        </form>
        
        <form id="loginForm" class="auth-form">
          <input type="text" id="loginNickname" placeholder="–ù–∏–∫–Ω–µ–π–º" class="w-full p-3 border rounded mb-3 bg-gray-700 text-white border-gray-600">
          
          <div class="password-container mb-3">
            <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å" class="w-full p-3 border rounded bg-gray-700 text-white border-gray-600 pr-10">
            <button type="button" class="password-toggle" onclick="togglePasswordVisibility('loginPassword', 'loginPasswordToggle')">
              <span id="loginPasswordToggle">üëÅÔ∏è</span>
            </button>
          </div>
          
          <div class="captcha-code" id="loginCaptchaCode">GHIJKL</div>
          <input type="text" id="loginCaptchaInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ —Å –∫–∞—Ä—Ç–∏–Ω–∫–∏" class="w-full p-3 border rounded mb-4 bg-gray-700 text-white border-gray-600">
          <button type="button" onclick="login()" class="w-full px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">–í–æ–π—Ç–∏</button>

          <div class="mt-4 text-center">
            <button type="button" onclick="showForgotPassword()" class="text-blue-400 hover:text-blue-300 underline text-sm">
              –ù–µ –ø–æ–º–Ω—é –ø–∞—Ä–æ–ª—å
            </button>
          </div>
        </form>
      </div>
      
      <div id="profileSection" class="profile-section hidden">
        <div class="profile-avatar" onclick="document.getElementById('avatarInput').click()">
          <img id="profileAvatar" src="account.png" alt="–ê–≤–∞—Ç–∞—Ä" class="w-full h-full rounded-full">
          <div class="avatar-overlay">–°–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ</div>
          <input type="file" id="avatarInput" accept="image/*" class="hidden" onchange="changeAvatar(this.files[0])">
        </div>
        
        <div class="text-center mb-4">
          <div class="text-sm text-gray-400">–ù–∏–∫–Ω–µ–π–º:</div>
          <div id="profileNickname" class="text-lg font-bold"></div>
        </div>
        
        <div class="nickname-display">
          <span id="profileCurrentNickname" class="text-xl font-bold"></span>
        </div>

        <div class="mt-4">
          <button onclick="showBackupCodes()" class="w-full px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 mb-2">
            üîë –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–¥—ã
          </button>
        </div>

        <div class="mt-4">
          <button onclick="showChangePassword()" class="w-full px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600 mb-2">
            üîí –°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å
          </button>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤—Å–µ—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞) -->
        <div id="adminAccountsButton" class="mt-4 hidden">
          <button onclick="showAllAccounts()" class="w-full px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 mb-2">
            üë• –í—Å–µ –∞–∫–∫–∞—É–Ω—Ç—ã
          </button>
        </div>

        <div class="mt-4 pt-4 border-t border-gray-600">
          <button onclick="showLogoutConfirm()" class="w-full px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
            –í—ã—Ö–æ–¥ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
  <div id="confirmRegisterModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="modal confirm-dialog w-11/12 max-w-md relative">
      <button onclick="closeConfirmRegister()" class="absolute top-2 right-2 text-2xl text-gray-400 hover:text-red-400">‚úñ</button>
      <h2 class="text-xl font-bold mb-4 text-white">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</h2>
      <p class="text-gray-300 mb-2">–í—ã —Ç–æ—á–Ω–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å –Ω–∏–∫–Ω–µ–π–º–æ–º "<span id="confirmNickname" class="font-bold text-blue-400"></span>"?</p>
      <p class="text-gray-300 mb-4 text-sm">–ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –≤—ã —Å–º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏ —Ç–æ–ª—å–∫–æ –ø–æ —ç—Ç–æ–º—É –Ω–∏–∫–Ω–µ–π–º—É, –¥–∞–∂–µ –µ—Å–ª–∏ –≤—ã –µ–≥–æ –ø–æ–º–µ–Ω—è–µ—Ç–µ.</p>
      <div class="flex space-x-2">
        <button onclick="closeConfirmRegister()" class="flex-1 px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">–û—Ç–º–µ–Ω–∞</button>
        <button onclick="register()" class="flex-1 px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤—ã—Ö–æ–¥–∞ -->
  <div id="confirmLogoutModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="modal confirm-dialog w-11/12 max-w-md relative">
      <button onclick="closeConfirmLogout()" class="absolute top-2 right-2 text-2xl text-gray-400 hover:text-red-400">‚úñ</button>
      <h2 class="text-xl font-bold mb-4 text-white">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã—Ö–æ–¥–∞</h2>
      <p class="text-gray-300 mb-4">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?</p>
      <div class="flex space-x-2">
        <button onclick="closeConfirmLogout()" class="flex-1 px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">–û—Ç–º–µ–Ω–∞</button>
        <button onclick="logout()" class="flex-1 px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">–í—ã–π—Ç–∏</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–¥–æ–≤ -->
  <div id="backupCodesModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="modal bg-gray-800 p-6 rounded-2xl shadow-xl w-11/12 max-w-md relative">
      <button onclick="closeBackupCodes()" class="absolute top-2 right-2 text-2xl text-gray-400 hover:text-red-400">‚úñ</button>
      <h2 class="text-xl font-bold mb-4 text-white">üîë –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–¥—ã</h2>
      <p class="text-gray-300 mb-4">–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç–∏ –∫–æ–¥—ã –≤ –Ω–∞–¥–µ–∂–Ω–æ–º –º–µ—Å—Ç–µ. –û–Ω–∏ –ø–æ–Ω–∞–¥–æ–±—è—Ç—Å—è –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞:</p>
      
      <div id="backupCodesList" class="mb-4">
        <div class="backup-code">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div class="backup-code">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div class="backup-code">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è -->
  <div id="changePasswordModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="modal bg-gray-800 p-6 rounded-2xl shadow-xl w-11/12 max-w-md relative">
      <button onclick="closeChangePassword()" class="absolute top-2 right-2 text-2xl text-gray-400 hover:text-red-400">‚úñ</button>
      <h2 class="text-xl font-bold mb-4 text-white">üîí –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</h2>
      
      <div class="password-container mb-3">
        <input type="password" id="currentPassword" placeholder="–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å" class="w-full p-3 border rounded bg-gray-700 text-white border-gray-600 pr-10">
        <button type="button" class="password-toggle" onclick="togglePasswordVisibility('currentPassword', 'currentPasswordToggle')">
          <span id="currentPasswordToggle">üëÅÔ∏è</span>
        </button>
      </div>
      
      <div class="password-container mb-3">
        <input type="password" id="newPassword" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" class="w-full p-3 border rounded bg-gray-700 text-white border-gray-600 pr-10">
        <button type="button" class="password-toggle" onclick="togglePasswordVisibility('newPassword', 'newPasswordToggle')">
          <span id="newPasswordToggle">üëÅÔ∏è</span>
        </button>
      </div>
      
      <div class="password-container mb-4">
        <input type="password" id="confirmNewPassword" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" class="w-full p-3 border rounded bg-gray-700 text-white border-gray-600 pr-10">
        <button type="button" class="password-toggle" onclick="togglePasswordVisibility('confirmNewPassword', 'confirmNewPasswordToggle')">
          <span id="confirmNewPasswordToggle">üëÅÔ∏è</span>
        </button>
      </div>
      
      <button onclick="changePassword()" class="w-full px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å
      </button>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è -->
  <div id="forgotPasswordModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="modal bg-gray-800 p-6 rounded-2xl shadow-xl w-11/12 max-w-md relative">
      <button onclick="closeForgotPassword()" class="absolute top-2 right-2 text-2xl text-gray-400 hover:text-red-400">‚úñ</button>
      <h2 class="text-xl font-bold mb-4 text-white">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è</h2>
      
      <input type="text" id="recoveryNickname" placeholder="–í–∞—à –Ω–∏–∫–Ω–µ–π–º" class="w-full p-3 border rounded mb-4 bg-gray-700 text-white border-gray-600">
      
      <div class="mb-4">
        <p class="text-gray-300 mb-2">–í–≤–µ–¥–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –≤–∞—à–∏—Ö —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–¥–æ–≤:</p>
        <input type="text" id="recoveryBackupCode" placeholder="XXXX-XXXX" class="w-full p-3 border rounded bg-gray-700 text-white border-gray-600">
      </div>
      
      <div class="password-container mb-4">
        <input type="password" id="newPasswordRecovery" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" class="w-full p-3 border rounded bg-gray-700 text-white border-gray-600 pr-10">
        <button type="button" class="password-toggle" onclick="togglePasswordVisibility('newPasswordRecovery', 'newPasswordRecoveryToggle')">
          <span id="newPasswordRecoveryToggle">üëÅÔ∏è</span>
        </button>
      </div>
      
      <button onclick="recoverPassword()" class="w-full px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
        –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å
      </button>
      
      <div id="passwordRecoveryResult" class="mt-4 p-3 bg-gray-700 rounded hidden"></div>
    </div>
  </div>

  <!-- Changelog –º–æ–¥–∞–ª–∫–∞ -->
  <div id="changelogModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="modal bg-gray-800 p-6 rounded-2xl shadow-xl w-11/12 max-w-3xl relative">
      <button onclick="closeChangelog()" class="absolute top-2 right-2 text-2xl text-gray-400 hover:text-red-400">‚úñ</button>
      <h2 class="text-xl font-bold mb-4 text-white">Changelog</h2>
      <pre class="whitespace-pre-wrap text-sm text-white">[+] Mini-Chat
[+] –î–æ–±–∞–≤–∏–ª–∏ Admin Panel
[+] –£–ª—É—á—à–∏–ª–∏ –¥–∏–∑–∞–π–Ω —á–∞—Ç–∞
[+] –£–ª—É—á—à–∏–ª–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –º–∞—Ç–æ–≤
[+] –î–æ–±–∞–≤–∏–ª–∏ —Å–∏—Å—Ç–µ–º—É –∞–∫–∫–∞—É–Ω—Ç–æ–≤
[+] –î–æ–±–∞–≤–∏–ª–∏ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–¥—ã
[+] –î–æ–±–∞–≤–∏–ª–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è</pre>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
  <div id="usersModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="modal bg-gray-800 p-6 rounded-2xl shadow-xl w-11/12 max-w-md relative">
      <button onclick="closeUsersModal()" class="absolute top-2 right-2 text-2xl text-gray-400 hover:text-red-400">‚úñ</button>
      <h2 class="text-xl font-bold mb-4 text-white">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>
      <div class="text-sm text-gray-400 mb-2">–û–Ω–ª–∞–π–Ω –≤ —á–∞—Ç–µ (<span id="onlineUsersCount">0</span>):</div>
      <div id="onlineUsersList" class="max-h-48 overflow-y-auto mb-4"></div>
      <div class="text-sm text-gray-400 mb-2">–ë—ã–ª–∏ –≤ —á–∞—Ç–µ (–æ—Ñ—Ñ–ª–∞–π–Ω):</div>
      <div id="offlineUsersList" class="max-h-48 overflow-y-auto"></div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –≤—Å–µ—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤ -->
  <div id="allAccountsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="modal bg-gray-800 p-6 rounded-2xl shadow-xl w-11/12 max-w-md relative">
      <button onclick="closeAllAccountsModal()" class="absolute top-2 right-2 text-2xl text-gray-400 hover:text-red-400">‚úñ</button>
      <h2 class="text-xl font-bold mb-4 text-white">üë• –í—Å–µ –∞–∫–∫–∞—É–Ω—Ç—ã</h2>
      <div id="allAccountsList" class="max-h-96 overflow-y-auto"></div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞ -->
  <div id="confirmDeleteAccountModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="modal confirm-dialog w-11/12 max-w-md relative">
      <button onclick="closeConfirmDeleteAccount()" class="absolute top-2 right-2 text-2xl text-gray-400 hover:text-red-400">‚úñ</button>
      <h2 class="text-xl font-bold mb-4 text-white">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h2>
      <p class="text-gray-300 mb-4">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç "<span id="deleteAccountName" class="font-bold text-red-400"></span>"?</p>
      <div class="flex space-x-2">
        <button onclick="closeConfirmDeleteAccount()" class="flex-1 px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">–û—Ç–º–µ–Ω–∞</button>
        <button onclick="deleteAccount()" class="flex-1 px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <script>
    // ==================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE ====================
    const firebaseConfig = {
      apiKey: "AIzaSyD4SjU8HuZZZwruDnXQ3Mz1l6mj9xpn8EU",
      authDomain: "school-diary-8a.firebaseapp.com",
      databaseURL: "https://school-diary-8a-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "school-diary-8a",
      storageBucket: "school-diary-8a.firebasestorage.app",
      messagingSenderId: "252043407645",
      appId: "1:252043407645:web:ebde5ca5405273a07571f4"
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–¥–º–∏–Ω—Å–∫–æ–≥–æ IP
    const ADMIN_IP = "171.33.254.90";
    
    let isAdmin = false;
    let homework = {};
    let currentEditingSubject = null;
    let currentEditingDay = null;
    let uploadedImage = null;
    let userName = "–ì–æ—Å—Ç—å_" + Math.floor(Math.random() * 1000);
    let chatRef = null;
    let onlineUsersRef = null;
    let userRef = null;
    let nextDeleteTime = null;
    let deleteTimerInterval = null;
    let onlineUsers = {};
    let lastMessageTime = 0;
    let messageCooldown = 10000; // 10 —Å–µ–∫—É–Ω–¥
    let isLoggedIn = false;
    let currentUser = null;
    let chatUsersRef = null;
    let allUsersRef = null;
    let isChatOpen = false;
    let userIP = null;
    let accountToDelete = null;
    
    const lessons = {
      mon: ["–ê–ª–≥–µ–±—Ä–∞","–†–û–í","–•–∏–º–∏—è","–ì–µ–æ–≥—Ä–∞—Ñ–∏—è","–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫","–§–∏–∑–∏–∫–∞","–ë–∏–æ–ª–æ–≥–∏—è"],
      tue: ["–ì–µ–æ–º–µ—Ç—Ä–∏—è","–¢–µ–æ—Ä–∏—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏","–§–ö","–ò—Å—Ç–æ—Ä–∏—è","–†—É—Å—Å–∫–∏–π —è–∑—ã–∫","–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞"],
      wed: ["–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫","–§–ö","–†—É—Å—Å–∫–∏–π —è–∑—ã–∫","–ê–ª–≥–µ–±—Ä–∞","–ì–µ–æ–≥—Ä–∞—Ñ–∏—è","–ò–ö–¢"],
      thu: ["–§–∏–∑–∏–∫–∞","–ì–µ–æ–º–µ—Ç—Ä–∏—è","–ú—É–∑—ã–∫–∞","–•–∏–º–∏—è","–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞","–†—É—Å—Å–∫–∏–π —è–∑—ã–∫"],
      fri: ["–û–±—â–µ—Å—Ç–≤–æ","–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è","–ê–ª–≥–µ–±—Ä–∞","–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫","–ë–∏–æ–ª–æ–≥–∏—è","–û–ë–ñ","–ò—Å—Ç–æ—Ä–∏—è"]
    };

    // –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –º–∞—Ç–æ–≤ –∏ –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏–π
    const badWords = [
      '—Å—É–∫–∞', '–±–ª—è', '—Ö—É–π', '–ø–∏–∑–¥–∞', '–µ–±–∞–Ω', '–µ–±–∞—Ç—å', '–µ–±–ª–æ', '–≥–æ–Ω–¥–æ–Ω', '–º—É–¥–∞–∫', '–ø–∏–¥–æ—Ä', 
      '–¥–æ–ª–±–æ–µ–±', '–∑–∞–ª—É–ø–∞', '—à–ª—é—Ö–∞', '–±–ª—è–¥—å', '–∞—Ö—É–µ—Ç—å', '–æ—Ö—É–µ—Ç—å', '–ø–∏–∑–¥–µ—Ü', '–µ–±–∞–ª', '–≤—ã–µ–±',
      '–≥–∞–Ω–¥–æ–Ω', '–º—É–¥–∏–ª–∞', '—Å—Å–∞–Ω–∏–Ω–∞', '—Å—Å–∞—Ç—å', '—Å—Ä–∞—Ç—å', '—Å—Ä–∞–Ω', '–¥—Ä–∏—Å—Ç', '–¥–µ—Ä—å–º–æ', '–≥–æ–≤–Ω–æ',
      '–∑–∞–ª—É–ø', '–º–∞–Ω–¥–∞', '–º—Ä–∞–∑—å', '–ø–∞–¥–ª–∞', '–ø–∞–¥–ª–æ', '—Å—É—á–∫–∞', '—Ç–≤–∞—Ä—å', '—É–±–ª—é–¥–æ–∫', '—É–µ–±–∞–Ω',
      '—Ö—É–µ—Å–æ—Å', '—Ö—É–π–Ω—è', '—à–ª—é—Ö', '–±–ª—è–¥–∏–Ω–∞', '–±–ª—è–¥—Å–∫–∏–π', '–≤—ã–µ–±—ã–≤–∞—Ç—å—Å—è', '–¥—Ä–æ—á–∏—Ç—å', '–¥—Ä–æ—á',
      '–µ–±–Ω—É—Ç—å', '–µ–±–Ω—É—Ç—ã–π', '–µ–±—É—á–∏–π', '–∑–∞–µ–±', '–∑–∞–µ–±–∞', '–Ω–∞–µ–±', '–æ—Ö—É–µ–≤–∞', '–ø–µ—Ä–µ–µ–±', '–ø–æ–¥—ä–µ–±',
      '—Ä–∞–∑—ä–µ–±', '—Å—ä–µ–±', '—É–µ–±', 'fuck', 'shit', 'bitch', 'asshole', 'dick', 'pussy', 'cunt',
      'ass', 'cock', 'whore', 'slut', 'nigger', 'nigga', 'faggot', 'retard', 'motherfucker'
    ];

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–¥–∞
    function generateBackupCode() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let result = '';
      for (let i = 0; i < 8; i++) {
        if (i === 4) result += '-';
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return result;
    }

    // –ü–æ–ª—É—á–∞–µ–º IP –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function getUserIP() {
      try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        userIP = data.ip;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º
        if (userIP === ADMIN_IP) {
          isAdmin = true;
          document.getElementById('syncButtonContainer').classList.remove('hidden');
          document.getElementById('adminUsersButton').classList.remove('hidden');
        }
        
        return data.ip;
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è IP:', error);
        userIP = 'unknown';
        return 'unknown';
      }
    }

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–π –∫–∞–ø—Ç—á–∏
    function generateCaptcha() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let result = '';
      for (let i = 0; i < 6; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return result;
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–∞—Ä–æ–ª—è
    function togglePasswordVisibility(inputId, toggleId) {
      const input = document.getElementById(inputId);
      const toggle = document.getElementById(toggleId);
      
      if (input.type === 'password') {
        input.type = 'text';
        toggle.textContent = 'üîí';
        setTimeout(() => {
          input.type = 'password';
          toggle.textContent = 'üëÅÔ∏è';
        }, 5000);
      } else {
        input.type = 'password';
        toggle.textContent = 'üëÅÔ∏è';
      }
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤
    function deleteAllAccounts() {
      if (!isAdmin) return;
      
      if (confirm("‚ùå –í–´ –£–í–ï–†–ï–ù–´? –≠—Ç–æ —É–¥–∞–ª–∏—Ç –í–°–ï –∞–∫–∫–∞—É–Ω—Ç—ã –Ω–∞–≤—Å–µ–≥–¥–∞!")) {
        database.ref('users').remove()
          .then(() => {
            showNotification('‚úÖ –í—Å–µ –∞–∫–∫–∞—É–Ω—Ç—ã —É–¥–∞–ª–µ–Ω—ã', 'success');
            // –¢–∞–∫–∂–µ –æ—á–∏—â–∞–µ–º –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            database.ref('chatOnlineUsers').remove();
          })
          .catch(error => {
            showNotification('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error');
            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–æ–≤:', error);
          });
      }
    }

    // –ó–≤—É–∫–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
    function playSound(soundName) {
      try {
        const audio = new Audio(soundName + '.wav');
        audio.play().catch(e => console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∑–≤—É–∫:', e));
      } catch (error) {
        console.log('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–∞:', error);
      }
    }

    // ==================== –£–°–ò–õ–ï–ù–ù–´–ô –§–ò–õ–¨–¢–† –ú–ê–¢–û–í ====================
    function filterBadWords(text) {
      if (!text) return text;
      
      let filteredText = text;
      
      // –£–¥–∞–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã, —Ç–æ—á–∫–∏ –∏ –¥—Ä—É–≥–∏–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
      const cleanText = text.replace(/[\s\.\_\-]/g, '').toLowerCase();
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –æ–±—ã—á–Ω—ã–µ –º–∞—Ç—ã
      for (const word of badWords) {
        if (cleanText.includes(word)) {
          return '';
        }
        
        // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å —Ä–∞–∑–Ω—ã–º–∏ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏
        const regexPattern = word.split('').join('[\\s\\.\\_\\-]*');
        const regex = new RegExp(regexPattern, 'gi');
        if (regex.test(text.toLowerCase())) {
          return '';
        }
      }
      
      return filteredText;
    }

    // ==================== –ê–í–¢–û–£–î–ê–õ–ï–ù–ò–ï –ß–ê–¢–ê ====================
    function calculateNextDeleteTime() {
      const now = new Date();
      const krasnoyarskOffset = 7 * 60 * 60 * 1000;
      const localOffset = now.getTimezoneOffset() * 60 * 1000;
      const krasnoyarskTime = new Date(now.getTime() + localOffset + krasnoyarskOffset);
      
      const deleteHours = [6, 12, 18, 24];
      let nextDeleteHour = null;
      
      for (const hour of deleteHours) {
        if (krasnoyarskTime.getHours() < hour) {
          nextDeleteHour = hour;
          break;
        }
      }
      
      if (nextDeleteHour === null) {
        nextDeleteHour = deleteHours[0];
        krasnoyarskTime.setDate(krasnoyarskTime.getDate() + 1);
      }
      
      krasnoyarskTime.setHours(nextDeleteHour, 0, 0, 0);
      return new Date(krasnoyarskTime.getTime() - localOffset - krasnoyarskOffset);
    }
    
    function updateDeleteTimer() {
      if (!nextDeleteTime) {
        nextDeleteTime = calculateNextDeleteTime();
      }
      
      const now = new Date();
      const timeLeft = nextDeleteTime - now;
      
      if (timeLeft <= 0) {
        if (chatRef) {
          chatRef.remove();
          nextDeleteTime = calculateNextDeleteTime();
        }
        return;
      }
      
      const hours = Math.floor(timeLeft / (1000 * 60 * 60));
      const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
      
      const timerElement = document.getElementById('deleteTimer');
      if (timerElement) {
        timerElement.textContent = `–∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑: ${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      }
    }
    
    function startDeleteTimer() {
      updateDeleteTimer();
      deleteTimerInterval = setInterval(updateDeleteTimer, 1000);
    }

    // ==================== –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ====================
    function showNotification(message, type = 'success') {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = `notification ${type} show`;
      
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.classList.add('hidden'), 300);
      }, 3000);
    }

    // ==================== –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨ ====================
    function toggleAdminLogin() {
      const adminLogin = document.getElementById('adminLogin');
      adminLogin.classList.toggle('hidden');
    }

    function loginAdmin() {
      const password = document.getElementById('adminPassword').value;
      
      if (password === "7777") {
        isAdmin = true;
        document.getElementById('syncButtonContainer').classList.remove('hidden');
        document.getElementById('adminLogin').classList.add('hidden');
        document.getElementById('adminUsersButton').classList.remove('hidden');
        showNotification('‚úÖ –í—ã –≤–æ—à–ª–∏ –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä', 'success');
        renderAll();
      } else {
        showNotification('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å', 'error');
      }
      
      document.getElementById('adminPassword').value = "";
    }

    // ==================== FIREBASE ====================
    function loadData() {
      updateSyncStatus('syncing', '–ó–∞–≥—Ä—É–∑–∫–∞...');
      
      const homeworkRef = database.ref('homework');
      
      homeworkRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          homework = data;
          renderAll();
          updateSyncStatus('online', `${new Date().toLocaleTimeString()}`);
          localStorage.setItem('diaryHomework', JSON.stringify(homework));
        } else {
          createInitialData();
        }
      }, (error) => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
        loadFromLocal();
      });
    }

    function saveData() {
      updateSyncStatus('syncing', '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...');
      
      database.ref('homework').set(homework)
        .then(() => {
          updateSyncStatus('online', '‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');
          localStorage.setItem('diaryHomework', JSON.stringify(homework));
        })
        .catch((error) => {
          console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
          updateSyncStatus('offline', '‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
          localStorage.setItem('diaryHomework', JSON.stringify(homework));
        });
    }

    function createInitialData() {
      const initialData = {};
      
      Object.keys(lessons).forEach(day => {
        initialData[day] = {};
        lessons[day].forEach(subject => {
          initialData[day][subject] = "";
        });
      });
      
      database.ref('homework').set(initialData)
        .then(() => {
          homework = initialData;
          renderAll();
        });
    }

    function loadFromLocal() {
      const saved = localStorage.getItem('diaryHomework');
      if (saved) {
        homework = JSON.parse(saved);
        renderAll();
        updateSyncStatus('offline', '–õ–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
      }
    }

    function updateSyncStatus(status, message) {
      const syncStatus = document.getElementById('syncStatus');
      
      if (syncStatus) syncStatus.textContent = message;
    }

    function forceSync() {
      const button = document.querySelector('#syncButtonContainer button');
      const originalText = button.textContent;
      
      button.textContent = "‚è≥ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...";
      button.disabled = true;
      
      loadData();
      
      setTimeout(() => {
        button.textContent = originalText;
        button.disabled = false;
      }, 1000);
    }

    // ==================== –ß–ê–¢ ====================
    function setupChat() {
      chatRef = database.ref('chat/messages');
      onlineUsersRef = database.ref('chatOnlineUsers');
      allUsersRef = database.ref('users');
      chatUsersRef = database.ref('chatUsers');
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const savedUser = localStorage.getItem('currentUser');
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        isLoggedIn = true;
        userName = currentUser.nickname;
        updateChatBlurOverlay();
      } else {
        // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, —Å–∫—Ä—ã–≤–∞–µ–º —á–∞—Ç
        document.getElementById('chatBlurOverlay').classList.remove('hidden');
        document.getElementById('chatMessages').innerHTML = '';
      }
      
      userRef = onlineUsersRef.push();
      
      window.addEventListener('beforeunload', () => {
        if (userRef) {
          userRef.remove();
        }
      });
      
      // –°–ª—É—à–∞–µ–º –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —á–∞—Ç–µ
      onlineUsersRef.on('value', (snapshot) => {
        onlineUsers = snapshot.val() || {};
        const onlineCount = Object.values(onlineUsers).filter(user => user.status === 'online').length;
        document.getElementById('onlineCount').textContent = onlineCount;
      });
      
      loadChatMessages();
      startDeleteTimer();
    }
    
    function updateChatBlurOverlay() {
      const blurOverlay = document.getElementById('chatBlurOverlay');
      if (isLoggedIn) {
        blurOverlay.classList.add('hidden');
        loadChatMessages(); // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö
      } else {
        blurOverlay.classList.remove('hidden');
        document.getElementById('chatMessages').innerHTML = '';
      }
    }
    
    function updateUserStatus(status) {
      if (userRef && currentUser) {
        userRef.set({
          nickname: currentUser.nickname,
          avatar: currentUser.avatar,
          status: status,
          lastSeen: firebase.database.ServerValue.TIMESTAMP
        });
      }
    }
    
    function loadChatMessages() {
      if (!isLoggedIn) return;
      
      chatRef.limitToLast(50).on('value', (snapshot) => {
        const messages = snapshot.val();
        const messagesContainer = document.getElementById('chatMessages');
        messagesContainer.innerHTML = '';
        
        if (messages) {
          Object.values(messages).forEach(msg => {
            if (msg && (msg.text || msg.sticker)) {
              if (msg.sticker) {
                addStickerToChat(msg.name, msg.sticker, msg.timestamp, msg.name === userName);
              } else {
                addMessageToChat(msg.name, msg.text, msg.timestamp, msg.name === userName);
              }
            }
          });
          
          // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
          setTimeout(() => {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
          }, 100);
        }
      });
    }
    
    function addMessageToChat(name, text, timestamp, isOwn = false) {
      const messagesContainer = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message-container ${isOwn ? 'own' : ''}`;
      
      const time = new Date(timestamp);
      const timeStr = time.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      
      // –ù–∞—Ö–æ–¥–∏–º –∞–≤–∞—Ç–∞—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      let userAvatar = 'account.png';
      if (currentUser && name === currentUser.nickname) {
        userAvatar = currentUser.avatar || 'account.png';
      }
      
      messageDiv.innerHTML = `
        <img src="${userAvatar}" class="avatar" alt="${name}">
        <div class="message-bubble ${isOwn ? 'own' : 'other'}">
          <div class="message-sender">${isOwn ? '–í—ã' : name}</div>
          <div class="message-text">${text}</div>
          <div class="message-time">${timeStr}</div>
        </div>
      `;
      
      messagesContainer.appendChild(messageDiv);
    }
    
    function addStickerToChat(name, stickerUrl, timestamp, isOwn = false) {
      const messagesContainer = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message-container ${isOwn ? 'own' : ''}`;
      
      const time = new Date(timestamp);
      const timeStr = time.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      
      // –ù–∞—Ö–æ–¥–∏–º –∞–≤–∞—Ç–∞—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      let userAvatar = 'account.png';
      if (currentUser && name === currentUser.nickname) {
        userAvatar = currentUser.avatar || 'account.png';
      }
      
      messageDiv.innerHTML = `
        <img src="${userAvatar}" class="avatar" alt="${name}">
        <div class="message-bubble ${isOwn ? 'own' : 'other'}" style="background: none; padding: 0;">
          <div class="message-sender">${isOwn ? '–í—ã' : name}</div>
          <img src="${stickerUrl}" class="chat-sticker">
          <div class="message-time">${timeStr}</div>
        </div>
      `;
      
      messagesContainer.appendChild(messageDiv);
    }
    
    function sendChatMessage() {
      if (!isLoggedIn) {
        showNotification('‚ùå –í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è', 'error');
        return;
      }
      
      const now = Date.now();
      if (now - lastMessageTime < messageCooldown) {
        const timeLeft = Math.ceil((messageCooldown - (now - lastMessageTime)) / 1000);
        showNotification(`‚ùå –ü–æ–¥–æ–∂–¥–∏—Ç–µ ${timeLeft} —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π', 'error`);
        return;
      }
      
      const input = document.getElementById('chatInput');
      let text = input.value.trim();
      
      if (text) {
        // –§–∏–ª—å—Ç—Ä—É–µ–º –º–∞—Ç—ã
        const filteredText = filterBadWords(text);
        if (filteredText === '') {
          showNotification('‚ùå –°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ —Å–ª–æ–≤–∞', 'error');
          input.value = '';
          return;
        }
        
        chatRef.push({
          name: userName,
          text: filteredText,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        });
        
        input.value = '';
        lastMessageTime = now;
        updateSendButtonCooldown();
      }
    }
    
    function sendSticker(stickerUrl) {
      if (!isLoggedIn) {
        showNotification('‚ùå –í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å—Ç–∏–∫–µ—Ä—ã', 'error');
        return;
      }
      
      const now = Date.now();
      if (now - lastMessageTime < messageCooldown) {
        const timeLeft = Math.ceil((messageCooldown - (now - lastMessageTime)) / 1000);
        showNotification(`‚ùå –ü–æ–¥–æ–∂–¥–∏—Ç–µ ${timeLeft} —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π', 'error`);
        return;
      }
      
      chatRef.push({
          name: userName,
          sticker: stickerUrl,
          timestamp: firebase.database.ServerValue.TIMESTAMP
      });
      
      toggleStickerPicker();
      lastMessageTime = now;
      updateSendButtonCooldown();
    }
    
    function updateSendButtonCooldown() {
      const button = document.getElementById('sendButton');
      button.disabled = true;
      button.textContent = '10';
      
      let secondsLeft = 10;
      const countdown = setInterval(() => {
        secondsLeft--;
        button.textContent = secondsLeft.toString();
        
        if (secondsLeft === 0) {
          clearInterval(countdown);
          button.disabled = false;
          button.textContent = '‚û§';
        }
      }, 1000);
    }
    
    function toggleStickerPicker() {
      const stickerPicker = document.getElementById('stickerPicker');
      stickerPicker.classList.toggle('hidden');
    }
    
    function handleChatKeyPress(event) {
      if (event.key === 'Enter') {
        sendChatMessage();
      }
    }
    
    function toggleChat() {
      const chatModal = document.getElementById('chatModal');
      if (chatModal.classList.contains('hidden')) {
        openChat();
      } else {
        closeChat();
      }
    }
    
    function openChat() {
      document.getElementById('chatModal').classList.remove('hidden');
      setTimeout(() => {
        document.querySelector('#chatModal .modal').classList.add('show');
        document.getElementById('chatInput').focus();
      }, 10);
      
      isChatOpen = true;
      if (isLoggedIn) {
        updateUserStatus('online');
      }
      
      // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
      setTimeout(() => {
        const messagesContainer = document.getElementById('chatMessages');
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }, 100);
    }
    
    function closeChat() {
      const modal = document.querySelector('#chatModal .modal');
      modal.classList.remove('show');
      setTimeout(() => document.getElementById('chatModal').classList.add('hidden'), 250);
      document.getElementById('stickerPicker').classList.add('hidden');
      
      isChatOpen = false;
      if (isLoggedIn) {
        updateUserStatus('away');
      }
    }

    // ==================== –°–ò–°–¢–ï–ú–ê –ê–ö–ö–ê–£–ù–¢–û–í ====================
    function openAccountModal() {
      document.getElementById('accountModal').classList.remove('hidden');
      setTimeout(() => {
        document.querySelector('#accountModal .modal').classList.add('show');
      }, 10);
      
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ –∫–∞–ø—Ç—á–∏
      document.getElementById('regCaptchaCode').textContent = generateCaptcha();
      document.getElementById('loginCaptchaCode').textContent = generateCaptcha();
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Å–µ–∫—Ü–∏—é
      if (isLoggedIn && currentUser) {
        document.getElementById('authSection').classList.add('hidden');
        document.getElementById('profileSection').classList.remove('hidden');
        document.getElementById('profileNickname').textContent = currentUser.nickname;
        document.getElementById('profileCurrentNickname').textContent = currentUser.nickname;
        if (currentUser.avatar) {
          document.getElementById('profileAvatar').src = currentUser.avatar;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∞–¥–º–∏–Ω–∞ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω
        if (isAdmin) {
          document.getElementById('adminAccountsButton').classList.remove('hidden');
        } else {
          document.getElementById('adminAccountsButton').classList.add('hidden');
        }
      } else {
        document.getElementById('authSection').classList.remove('hidden');
        document.getElementById('profileSection').classList.add('hidden');
      }
    }
    
    function closeAccountModal() {
      const modal = document.querySelector('#accountModal .modal');
      modal.classList.remove('show');
      setTimeout(() => document.getElementById('accountModal').classList.add('hidden'), 250);
    }
    
    function switchAuthTab(tab) {
      document.querySelectorAll('.auth-tab').forEach(t => {
        t.classList.remove('active');
        setTimeout(() => {
          if (t === document.querySelector(`.auth-tab:${tab === 'register' ? 'first' : 'last'}-child`)) {
            t.classList.add('active');
          }
        }, 150);
      });
      
      document.querySelectorAll('.auth-form').forEach(f => {
        f.classList.remove('active');
        setTimeout(() => {
          if (f.id === (tab === 'register' ? 'registerForm' : 'loginForm')) {
            f.classList.add('active');
          }
        }, 150);
      });
    }
    
    function showRegisterConfirm() {
      const nickname = document.getElementById('regNickname').value.trim();
      if (nickname.length < 4 || nickname.length > 12) {
        showNotification('‚ùå –ù–∏–∫–Ω–µ–π–º –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 4 –¥–æ 12 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
        return;
      }
      
      document.getElementById('confirmNickname').textContent = nickname;
      document.getElementById('confirmRegisterModal').classList.remove('hidden');
      setTimeout(() => {
        document.querySelector('#confirmRegisterModal .modal').classList.add('show');
      }, 10);
    }
    
    function closeConfirmRegister() {
      const modal = document.querySelector('#confirmRegisterModal .modal');
      modal.classList.remove('show');
      setTimeout(() => document.getElementById('confirmRegisterModal').classList.add('hidden'), 250);
    }
    
    function register() {
      closeConfirmRegister();
      
      const nickname = document.getElementById('regNickname').value.trim();
      const password = document.getElementById('regPassword').value;
      const confirmPassword = document.getElementById('regConfirmPassword').value;
      const captchaInput = document.getElementById('regCaptchaInput').value;
      const captchaCode = document.getElementById('regCaptchaCode').textContent;
      
      if (nickname.length < 4 || nickname.length > 12) {
        showNotification('‚ùå –ù–∏–∫–Ω–µ–π–º –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 4 –¥–æ 12 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
        return;
      }
      
      if (password.length < 6) {
        showNotification('‚ùå –ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
        return;
      }
      
      if (password !== confirmPassword) {
        showNotification('‚ùå –ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç', 'error');
        return;
      }
      
      if (captchaInput !== captchaCode) {
        showNotification('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –∫–∞–ø—Ç—á–∏', 'error');
        return;
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º IP
      if (!userIP) {
        showNotification('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∞—à IP', 'error');
        return;
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∞–∫–∫–∞—É–Ω—Ç —Å —ç—Ç–æ–≥–æ IP
      allUsersRef.orderByChild('ip').equalTo(userIP).once('value').then((snapshot) => {
        if (snapshot.exists()) {
          showNotification('‚ùå –° –≤–∞—à–µ–≥–æ IP —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –∞–∫–∫–∞—É–Ω—Ç', 'error');
          return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –Ω–∏–∫–Ω–µ–π–º–æ–º
        allUsersRef.child(nickname).once('value').then((userSnapshot) => {
          if (userSnapshot.exists()) {
            showNotification('‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –Ω–∏–∫–Ω–µ–π–º–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'error');
            return;
          }
          
          // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–¥—ã
          const backupCodes = [
            generateBackupCode(),
            generateBackupCode(),
            generateBackupCode()
          ];
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
          allUsersRef.child(nickname).set({
            nickname: nickname,
            password: password,
            avatar: 'account.png',
            ip: userIP,
            backupCodes: backupCodes,
            registeredAt: firebase.database.ServerValue.TIMESTAMP,
            lastSeen: firebase.database.ServerValue.TIMESTAMP
          }).then(() => {
            showNotification('‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!', 'success');
            isLoggedIn = true;
            currentUser = { 
              nickname, 
              avatar: 'account.png',
              backupCodes: backupCodes 
            };
            userName = nickname;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            updateChatBlurOverlay();
            
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('profileSection').classList.remove('hidden');
            document.getElementById('profileNickname').textContent = nickname;
            document.getElementById('profileCurrentNickname').textContent = nickname;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–¥—ã
            showBackupCodes();
          }).catch((error) => {
            showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏', 'error');
            console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
          });
        });
      });
    }
    
    function login() {
      const nickname = document.getElementById('loginNickname').value.trim();
      const password = document.getElementById('loginPassword').value;
      const captchaInput = document.getElementById('loginCaptchaInput').value;
      const captchaCode = document.getElementById('loginCaptchaCode').textContent;
      
      if (captchaInput !== captchaCode) {
        showNotification('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –∫–∞–ø—Ç—á–∏', 'error');
        return;
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
      allUsersRef.child(nickname).once('value').then((snapshot) => {
        if (!snapshot.exists()) {
          showNotification('‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
          return;
        }
        
        const userData = snapshot.val();
        if (userData.password !== password) {
          showNotification('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å', 'error');
          return;
        }
        
        showNotification('‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!', 'success');
        isLoggedIn = true;
        currentUser = {
          nickname: userData.nickname,
          avatar: userData.avatar || 'account.png',
          backupCodes: userData.backupCodes || []
        };
        userName = currentUser.nickname;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤—Ö–æ–¥–∞
        allUsersRef.child(nickname).update({
          lastSeen: firebase.database.ServerValue.TIMESTAMP
        });
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        updateChatBlurOverlay();
        
        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å
        document.getElementById('authSection').classList.add('hidden');
        document.getElementById('profileSection').classList.remove('hidden');
        document.getElementById('profileNickname').textContent = currentUser.nickname;
        document.getElementById('profileCurrentNickname').textContent = currentUser.nickname;
        document.getElementById('profileAvatar').src = currentUser.avatar;
      }).catch((error) => {
        showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ', 'error');
        console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error);
      });
    }
    
    function changeAvatar(file) {
      if (!file || !file.type.startsWith('image/')) {
        showNotification('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ', 'error');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = (e) => {
        document.getElementById('profileAvatar').src = e.target.result;
        if (currentUser) {
          currentUser.avatar = e.target.result;
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
          allUsersRef.child(currentUser.nickname).update({
            avatar: e.target.result
          });
        }
        showNotification('‚úÖ –ê–≤–∞—Ç–∞—Ä –∏–∑–º–µ–Ω—ë–Ω!', 'success');
      };
      reader.readAsDataURL(file);
    }
    
    function showLogoutConfirm() {
      document.getElementById('confirmLogoutModal').classList.remove('hidden');
      setTimeout(() => {
        document.querySelector('#confirmLogoutModal .modal').classList.add('show');
      }, 10);
    }
    
    function closeConfirmLogout() {
      const modal = document.querySelector('#confirmLogoutModal .modal');
      modal.classList.remove('show');
      setTimeout(() => document.getElementById('confirmLogoutModal').classList.add('hidden'), 250);
    }
    
    function logout() {
      closeConfirmLogout();
      closeAccountModal();
      
      isLoggedIn = false;
      currentUser = null;
      userName = "–ì–æ—Å—Ç—å_" + Math.floor(Math.random() * 1000);
      localStorage.removeItem('currentUser');
      updateChatBlurOverlay();
      
      showNotification('‚úÖ –í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞', 'success');
    }

    // ==================== –†–ï–ó–ï–†–í–ù–´–ï –ö–û–î–´ ====================
    function showBackupCodes() {
      if (!isLoggedIn) {
        showNotification('‚ùå –í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç —á—Ç–æ–±—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–¥—ã', 'error');
        return;
      }
      
      document.getElementById('backupCodesModal').classList.remove('hidden');
      setTimeout(() => {
        document.querySelector('#backupCodesModal .modal').classList.add('show');
      }, 10);
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∫–æ–¥—ã –∏–∑ –±–∞–∑—ã
      allUsersRef.child(currentUser.nickname).once('value').then((snapshot) => {
        const userData = snapshot.val();
        if (userData && userData.backupCodes) {
          displayBackupCodes(userData.backupCodes);
        }
      });
    }
    
    function closeBackupCodes() {
      const modal = document.querySelector('#backupCodesModal .modal');
      modal.classList.remove('show');
      setTimeout(() => document.getElementById('backupCodesModal').classList.add('hidden'), 250);
    }
    
    function displayBackupCodes(codes) {
      const codesList = document.getElementById('backupCodesList');
      codesList.innerHTML = '';
      
      codes.forEach(code => {
        const codeElement = document.createElement('div');
        codeElement.className = 'backup-code';
        codeElement.textContent = code;
        codesList.appendChild(codeElement);
      });
    }

    // ==================== –°–ú–ï–ù–ê –ü–ê–†–û–õ–Ø ====================
    function showChangePassword() {
      document.getElementById('changePasswordModal').classList.remove('hidden');
      setTimeout(() => {
        document.querySelector('#changePasswordModal .modal').classList.add('show');
      }, 10);
    }
    
    function closeChangePassword() {
      const modal = document.querySelector('#changePasswordModal .modal');
      modal.classList.remove('show');
      setTimeout(() => document.getElementById('changePasswordModal').classList.add('hidden'), 250);
    }
    
    function changePassword() {
      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmNewPassword = document.getElementById('confirmNewPassword').value;
      
      if (newPassword.length < 6) {
        showNotification('‚ùå –ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
        return;
      }
      
      if (newPassword !== confirmNewPassword) {
        showNotification('‚ùå –ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç', 'error');
        return;
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å
      allUsersRef.child(currentUser.nickname).once('value').then((snapshot) => {
        const userData = snapshot.val();
        if (userData.password !== currentPassword) {
          showNotification('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å', 'error');
          return;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞—Ä–æ–ª—å
        allUsersRef.child(currentUser.nickname).update({
          password: newPassword
        }).then(() => {
          showNotification('‚úÖ –ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω', 'success');
          closeChangePassword();
        }).catch(error => {
          showNotification('‚ùå –û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è', 'error');
          console.error('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è:', error);
        });
      });
    }

    // ==================== –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –ü–ê–†–û–õ–Ø ====================
    function showForgotPassword() {
      document.getElementById('forgotPasswordModal').classList.remove('hidden');
      setTimeout(() => {
        document.querySelector('#forgotPasswordModal .modal').classList.add('show');
      }, 10);
    }
    
    function closeForgotPassword() {
      const modal = document.querySelector('#forgotPasswordModal .modal');
      modal.classList.remove('show');
      setTimeout(() => document.getElementById('forgotPasswordModal').classList.add('hidden'), 250);
    }
    
    function recoverPassword() {
      const nickname = document.getElementById('recoveryNickname').value.trim();
      const backupCode = document.getElementById('recoveryBackupCode').value.trim();
      const newPassword = document.getElementById('newPasswordRecovery').value;
      const resultDiv = document.getElementById('passwordRecoveryResult');
      
      if (newPassword.length < 6) {
        resultDiv.innerHTML = '<span class="text-red-400">‚ùå –ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤</span>';
        resultDiv.classList.remove('hidden');
        return;
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –∫–æ–¥
      allUsersRef.child(nickname).once('value').then((snapshot) => {
        if (!snapshot.exists()) {
          resultDiv.innerHTML = '<span class="text-red-400">‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω</span>';
          resultDiv.classList.remove('hidden');
          return;
        }
        
        const userData = snapshot.val();
        if (!userData.backupCodes || !userData.backupCodes.includes(backupCode)) {
          resultDiv.innerHTML = '<span class="text-red-400">‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –∫–æ–¥</span>';
          resultDiv.classList.remove('hidden');
          return;
        }
        
        // –£–¥–∞–ª—è–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–∞—Ä–æ–ª—å
        const updatedCodes = userData.backupCodes.filter(code => code !== backupCode);
        
        allUsersRef.child(nickname).update({
          password: newPassword,
          backupCodes: updatedCodes
        }).then(() => {
          resultDiv.innerHTML = '<span class="text-green-400">‚úÖ –ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏.</span>';
          resultDiv.classList.remove('hidden');
          
          // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
          setTimeout(() => {
            closeForgotPassword();
          }, 2000);
        }).catch(error => {
          resultDiv.innerHTML = '<span class="text-red-400">‚ùå –û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è</span>';
          resultDiv.classList.remove('hidden');
          console.error('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è:', error);
        });
      });
    }

    // ==================== –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò –û–ù–õ–ê–ô–ù ====================
    function showOnlineUsers() {
      if (!isAdmin) return;
      
      const onlineUsersList = document.getElementById('onlineUsersList');
      const offlineUsersList = document.getElementById('offlineUsersList');
      onlineUsersList.innerHTML = '';
      offlineUsersList.innerHTML = '';
      
      // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –±–∞–∑—ã
      allUsersRef.once('value').then((usersSnapshot) => {
        const allUsers = usersSnapshot.val() || {};
        
        // –ü–æ–ª—É—á–∞–µ–º –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ —á–∞—Ç–∞
        onlineUsersRef.once('value').then((onlineSnapshot) => {
          const chatOnlineUsers = onlineSnapshot.val() || {};
          const onlineCount = Object.values(chatOnlineUsers).filter(user => user.status === 'online').length;
          document.getElementById('onlineUsersCount').textContent = onlineCount;
          
          // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
          Object.entries(chatOnlineUsers).forEach(([key, user]) => {
            if (user.status === 'online') {
              const userElement = document.createElement('div');
              userElement.className = 'user-status';
              userElement.innerHTML = `
                <span class="online-dot online"></span>
                <img src="${user.avatar || 'account.png'}" class="w-6 h-6 rounded-full">
                <span>${user.nickname}</span>
              `;
              onlineUsersList.appendChild(userElement);
            }
          });
          
          // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –æ—Ñ—Ñ–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ)
          Object.entries(allUsers).forEach(([nickname, userData]) => {
            const isOnline = Object.values(chatOnlineUsers).some(onlineUser => 
              onlineUser.nickname === nickname && onlineUser.status === 'online'
            );
            
            if (!isOnline) {
              const userElement = document.createElement('div');
              userElement.className = 'user-status';
              userElement.innerHTML = `
                <span class="online-dot offline"></span>
                <img src="${userData.avatar || 'account.png'}" class="w-6 h-6 rounded-full">
                <span>${nickname}</span>
              `;
              offlineUsersList.appendChild(userElement);
            }
          });
        });
      });
      
      document.getElementById('usersModal').classList.remove('hidden');
      setTimeout(() => {
        document.querySelector('#usersModal .modal').classList.add('show');
      }, 10);
    }
    
    function closeUsersModal() {
      const modal = document.querySelector('#usersModal .modal');
      modal.classList.remove('show');
      setTimeout(() => document.getElementById('usersModal').classList.add('hidden'), 250);
    }

    // ==================== –í–°–ï –ê–ö–ö–ê–£–ù–¢–´ (–ê–î–ú–ò–ù) ====================
    function showAllAccounts() {
      if (!isAdmin) return;
      
      const accountsList = document.getElementById('allAccountsList');
      accountsList.innerHTML = '';
      
      allUsersRef.once('value').then((snapshot) => {
        const users = snapshot.val() || {};
        
        if (Object.keys(users).length === 0) {
          accountsList.innerHTML = '<div class="text-center text-gray-400 py-4">–ù–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤</div>';
          return;
        }
        
        Object.entries(users).forEach(([nickname, userData]) => {
          const userElement = document.createElement('div');
          userElement.className = 'user-list-item';
          userElement.innerHTML = `
            <div class="user-info">
              <img src="${userData.avatar || 'account.png'}" class="w-8 h-8 rounded-full">
              <span>${nickname}</span>
            </div>
            <div class="delete-user-btn" onclick="confirmDeleteAccount('${nickname}')">
              üóëÔ∏è
            </div>
          `;
          accountsList.appendChild(userElement);
        });
      });
      
      document.getElementById('allAccountsModal').classList.remove('hidden');
      setTimeout(() => {
        document.querySelector('#allAccountsModal .modal').classList.add('show');
      }, 10);
    }
    
    function closeAllAccountsModal() {
      const modal = document.querySelector('#allAccountsModal .modal');
      modal.classList.remove('show');
      setTimeout(() => document.getElementById('allAccountsModal').classList.add('hidden'), 250);
    }
    
    function confirmDeleteAccount(nickname) {
      accountToDelete = nickname;
      document.getElementById('deleteAccountName').textContent = nickname;
      document.getElementById('confirmDeleteAccountModal').classList.remove('hidden');
      setTimeout(() => {
        document.querySelector('#confirmDeleteAccountModal .modal').classList.add('show');
      }, 10);
    }
    
    function closeConfirmDeleteAccount() {
      const modal = document.querySelector('#confirmDeleteAccountModal .modal');
      modal.classList.remove('show');
      setTimeout(() => document.getElementById('confirmDeleteAccountModal').classList.add('hidden'), 250);
      accountToDelete = null;
    }
    
    function deleteAccount() {
      if (!accountToDelete || !isAdmin) return;
      
      allUsersRef.child(accountToDelete).remove()
        .then(() => {
          showNotification('‚úÖ –ê–∫–∫–∞—É–Ω—Ç —É–¥–∞–ª—ë–Ω', 'success');
          closeConfirmDeleteAccount();
          showAllAccounts(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
        })
        .catch(error => {
          showNotification('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞', 'error');
          console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞:', error);
        });
    }

    // ==================== –†–ï–ù–î–ï–†–ò–ù–ì ====================
    function renderLessons(containerId, daySubjects) {
      const container = document.getElementById(containerId);
      container.innerHTML = "";
      
      daySubjects.forEach(subject => {
        const row = document.createElement("div");
        row.className = "subject-row flex justify-between items-center p-3";
        row.onclick = () => {};
        
        const left = document.createElement("div");
        left.className = "flex-1 pr-2";
        left.textContent = subject;
        
        const right = document.createElement("div");
        right.className = "flex items-center space-x-2";
        
        const currentHW = homework[containerId] && homework[containerId][subject];
        if (currentHW) {
          const dzIcon = document.createElement("span");
          dzIcon.className = "text-yellow-300 text-sm cursor-pointer";
          dzIcon.textContent = "üìù";
          dzIcon.title = "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –î–ó";
          dzIcon.onclick = (e) => {
            e.stopPropagation();
            openModal(subject, currentHW);
          };
          right.appendChild(dzIcon);
        }
        
        if (isAdmin) {
          const editBtn = document.createElement("button");
          editBtn.className = "text-blue-300 hover:text-blue-100 text-sm";
          editBtn.textContent = "‚úèÔ∏è";
          editBtn.title = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –î–ó";
          editBtn.onclick = (e) => {
            e.stopPropagation();
            editHW(subject, containerId);
          };
          right.appendChild(editBtn);
        }
        
        row.appendChild(left);
        row.appendChild(right);
        container.appendChild(row);
      });
    }

    function renderAll() {
      renderLessons("mon", lessons.mon);
      renderLessons("tue", lessons.tue);
      renderLessons("wed", lessons.wed);
      renderLessons("thu", lessons.thu);
      renderLessons("fri", lessons.fri);
      document.getElementById('syncButtonContainer').classList.toggle('hidden', !isAdmin);
      document.getElementById('adminUsersButton').classList.toggle('hidden', !isAdmin);
    }

    function editHW(subject, day) {
      currentEditingSubject = subject;
      currentEditingDay = day;
      const currentHW = homework[day] && homework[day][subject] || "";
      const textOnly = currentHW.replace(/!\[Image\]\(data:image\/[^)]+\)/g, '').trim();
      
      document.getElementById('editSubject').textContent = subject;
      document.getElementById('homeworkText').value = textOnly;
      document.getElementById('uploadedImagePreview').classList.add('hidden');
      uploadedImage = null;
      
      openEditModal();
    }

    function saveHomework() {
      const text = document.getElementById('homeworkText').value;
      
      if (!homework[currentEditingDay]) {
        homework[currentEditingDay] = {};
      }
      
      let hwContent = text;
      if (uploadedImage) {
        hwContent += `\n\n![Image](${uploadedImage})`;
      }
      
      homework[currentEditingDay][currentEditingSubject] = hwContent;
      saveData();
      closeEditModal();
      renderAll();
    }

    // ==================== –û–ë–†–ê–ë–û–¢–ö–ê –ö–û–ù–¢–ï–ù–¢–ê ====================
    function formatContent(content) {
      if (!content) return '<span class="text-gray-500">–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ –Ω–µ –∑–∞–¥–∞–Ω–æ</span>';
      
      let formattedContent = content;
      formattedContent = formattedContent.replace(
        /(https?:\/\/[^\s]+)/g, 
        '<a href="$1" target="_blank" class="content-link">$1</a>'
      );
      formattedContent = formattedContent.replace(
        /!\[Image\]\((data:image\/[^)]+)\)/g,
        '<img src="$1" class="content-image" alt="–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">'
      );
      formattedContent = formattedContent.replace(/\n/g, '<br>');
      
      return formattedContent;
    }

    // ==================== –ú–û–î–ê–õ–ö–ò ====================
    function openModal(subject, content) {
      document.getElementById("dzContent").innerHTML = `
        <h3 class="font-semibold text-lg mb-2">${subject}</h3>
        <div class="whitespace-pre-wrap">${formatContent(content)}</div>
      `;
      document.getElementById("dzModal").classList.remove("hidden");
      setTimeout(() => document.querySelector("#dzModal .modal").classList.add("show"), 10);
    }

    function closeModal() {
      const modal = document.querySelector("#dzModal .modal");
      modal.classList.remove("show");
      setTimeout(() => document.getElementById("dzModal").classList.add("hidden"), 250);
    }

    function openEditModal() {
      document.getElementById("editModal").classList.remove("hidden");
      setTimeout(() => document.querySelector("#editModal .modal").classList.add("show"), 10);
    }

    function closeEditModal() {
      const modal = document.querySelector("#editModal .modal");
      modal.classList.remove("show");
      setTimeout(() => document.getElementById("editModal").classList.add("hidden"), 250);
    }

    function openChangelog() {
      document.getElementById("changelogModal").classList.remove("hidden");
      setTimeout(() => document.querySelector("#changelogModal .modal").classList.add("show"), 10);
    }

    function closeChangelog() {
      const modal = document.querySelector("#changelogModal .modal");
      modal.classList.remove("show");
      setTimeout(() => document.getElementById("changelogModal").classList.add("hidden"), 250);
    }

    // ==================== –ó–ê–ì–†–£–ó–ö–ê –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô ====================
    function setupImageUpload() {
      const uploadArea = document.getElementById('imageUpload');
      const fileInput = document.getElementById('imageInput');
      const imagePreview = document.getElementById('uploadedImagePreview');
      
      uploadArea.addEventListener('click', () => {
        fileInput.click();
      });
      
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });
      
      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
      });
      
      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleImageUpload(files[0]);
        }
      });
      
      fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          handleImageUpload(e.target.files[0]);
        }
      });
    }
    
    function handleImageUpload(file) {
      if (!file.type.startsWith('image/')) {
        showNotification('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ', 'error');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = (e) => {
        uploadedImage = e.target.result;
        const imagePreview = document.getElementById('uploadedImagePreview');
        imagePreview.src = uploadedImage;
        imagePreview.classList.remove('hidden');
      };
      reader.readAsDataURL(file);
    }

    // ==================== –ó–ê–ü–£–°–ö ====================
    window.onload = async () => {
      // –ü–æ–ª—É—á–∞–µ–º IP –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      await getUserIP();
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
      const savedUser = localStorage.getItem('currentUser');
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        isLoggedIn = true;
        userName = currentUser.nickname;
      }
      
      loadData();
      setupImageUpload();
      setupChat();
      
      window.addEventListener('online', loadData);
      window.addEventListener('offline', () => {
        updateSyncStatus('offline', '–û—Ñ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º');
      });
    };

    window.addEventListener('click', (e) => {
      if (e.target.id === 'dzModal') closeModal();
      if (e.target.id === 'editModal') closeEditModal();
      if (e.target.id === 'chatModal') closeChat();
      if (e.target.id === 'changelogModal') closeChangelog();
      if (e.target.id === 'usersModal') closeUsersModal();
      if (e.target.id === 'accountModal') closeAccountModal();
      if (e.target.id === 'confirmRegisterModal') closeConfirmRegister();
      if (e.target.id === 'confirmLogoutModal') closeConfirmLogout();
      if (e.target.id === 'backupCodesModal') closeBackupCodes();
      if (e.target.id === 'changePasswordModal') closeChangePassword();
      if (e.target.id === 'forgotPasswordModal') closeForgotPassword();
      if (e.target.id === 'allAccountsModal') closeAllAccountsModal();
      if (e.target.id === 'confirmDeleteAccountModal') closeConfirmDeleteAccount();
    });
  </script>
</body>
</html>